<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eWings-papers - Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="student-dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
        <div class="sidebar-brand d-flex align-items-center justify-content-center">
            <img src="EW-white.png" alt="eWings Logo">
            <span class="ml-2">eWings Papers</span>
        </div>
        
        <div class="sidebar-user text-center">
            <div class="user-name" id="sidebarUserName">Welcome</div>
            <div class="user-email" id="sidebarUserEmail">Please login</div>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <div class="sidebar-heading">Main</div>
        <ul class="nav flex-column">
            <li class="nav-item" id="dashboardNavItem">
              <a class="nav-link active d-flex align-items-center" href="#" id="dashboardTab">
                  <i class="bi bi-speedometer2"></i>
                  <span>Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="papersTab">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Papers</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#" id="ranksTab">
                    <i class="bi bi-trophy"></i>
                    <span>My Ranks</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="statsTab">
                    <i class="bi bi-graph-up"></i>
                    <span>My Performance</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-divider"></div>
        <div class="sidebar-heading">Paper Class</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="#" id="paperClassTab">
                    <i class="bi bi-journal-text"></i>
                    <span>Paper Class</span>
                </a>
            </li>
            <li class="nav-item" id="paperClassRankingsTabItem">
                <a class="nav-link" href="#" id="paperClassRankingsTab">
                    <i class="bi bi-trophy"></i>
                    <span>Paper Class Rankings</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="paperClassPerformanceTab">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Paper Class Stats</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-divider"></div>
        <div class="sidebar-heading">Account</div>
        <ul class="nav flex-column" id="accountNavItems">
            <li class="nav-item">
                <a class="nav-link" href="#" id="profileBtn">
                    <i class="bi bi-person"></i>
                    <span>My Profile</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="bi bi-list"></i>
    </button>

    <!-- Content Wrapper -->
    <div id="content">
        <!-- Top Navigation -->
        <nav class="navbar navbar-expand topbar mb-4 static-top shadow">
            <div class="container-fluid">
                <button id="sidebarToggle" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="bi bi-list"></i>
                </button>
                
                <div class="d-flex align-items-center">
                    <button class="theme-toggle me-3" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-primary" id="authBtn">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Login
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid">
            <!-- Welcome Banner -->
            <div class="welcome-banner fade-in">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 id="welcomeMessage">Welcome to eWings-papers</h2>
                        <p id="welcomeSubtext">Please login to access your papers and performance data</p>
                    </div>
                    <!--<div class="col-md-4 d-none d-md-block">
                        <img src="Ukuwela-sir-banner.png" alt="eWings Banner" class="img-fluid rounded">
                    </div>-->
                </div>
            </div>
            <!--Dashboard-->

            <div id="dashboardSection" class="fade-in">
    <div id="dashboardAuthCheck" class="text-center py-5" style="display: none;">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Please login to access the dashboard
        </div>
        <button class="btn btn-primary mt-3" id="loginFromDashboardBtn">
            <i class="bi bi-box-arrow-in-right me-2"></i> Login
        </button>
    </div>

    <div id="dashboardContent">
        <h2 class="section-title">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </h2>

        <!-- Summary Cards Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card primary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="stat-value" id="totalPapersTaken">0</div>
                                <div class="stat-label">Papers Taken</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-file-earmark-text stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stat-card success">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="stat-value" id="averageScore">0%</div>
                                <div class="stat-label">Average Score</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-graph-up stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stat-card warning">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="stat-value" id="bestRank">N/A</div>
                                <div class="stat-label">Best Rank</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-trophy stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stat-card info">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="stat-value" id="improvementRate">0%</div>
                                <div class="stat-label">Improvement</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-arrow-up-right stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Overview Section -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i> Performance Overview
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performanceOverviewChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Latest Paper Top 10 Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-trophy me-2"></i> Latest Paper Top 10
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Name</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="latestPaperTop10">
                                    <!-- Will be populated by JavaScript -->
                                    <tr>
                                        <td colspan="3" class="text-center py-4">
                                            <div class="spinner-border"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Section -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-clock-history me-2"></i> Recent Activity
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush" id="recentActivityList">
                            <!-- Will be populated by JavaScript -->
                            <div class="text-center py-4">
                                <div class="spinner-border"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Papers Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-file-earmark-plus me-2"></i> New Papers
                </div>
                <a href="#" class="btn btn-sm btn-outline-primary" id="viewAllPapersBtn">
                    View All
                </a>
            </div>
            <div class="card-body">
                <div class="row" id="newPapersList">
                    <!-- Will be populated by JavaScript -->
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>

            <!-- Papers Section -->
            <div id="papersSection" class="fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title">
                        <i class="bi bi-file-earmark-text me-2"></i> Available Papers
                    </h2>
                    <div class="filter-container">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="yearFilter">
                                    <option value="">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="availablePapers">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <h2 class="section-title mt-5">
                    <i class="bi bi-file-earmark-check me-2"></i> View Answers
                </h2>
                <div class="row" id="viewAnswers">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranks Section -->
            <div id="ranksSection" style="display: none;" class="fade-in">
                <h2 class="section-title">
                    <i class="bi bi-trophy me-2"></i> Paper Rankings
                </h2>
  
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="filter-container">
                            <label for="rankPaperFilter" class="form-label">Select Paper</label>
                            <select class="form-select" id="rankPaperFilter">
                                <option value="">Select Paper</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="filter-container">
                            <label for="classFilter" class="form-label">Filter by Class</label>
                            <select class="form-select" id="classFilter">
                                <option value="">All Island</option>
                                <option value="Nugegoda">Nugegoda</option>
                                <option value="Kandy">Kandy</option>
                                <option value="Kegalle">Kegalle</option>
                                <option value="Kurunegala">Kurunegala</option>
                                <option value="Gall">Gall</option>
                                <option value="Onlin">Online</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Top Schools Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-trophy-fill me-2"></i> Top Schools
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="bi bi-star-fill me-2"></i> All Island Top School
                                    </div>
                                    <div class="card-body">
                                        <div id="overallTopSchool" class="text-center py-3">
                                            <div class="spinner-border"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="bi bi-award-fill me-2"></i> Class Top School
                                    </div>
                                    <div class="card-body">
                                        <div id="classTopSchool" class="text-center py-3">
                                            <div class="spinner-border"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- User Ranking filter - Only show when logged in -->
                <div id="userRankInfo" class="mb-4" style="display: none;">
                    <div class="alert alert-success">
                        <h5><i class="bi bi-trophy-fill me-2"></i> Your Rank</h5>
                        <div id="userRankDetails"></div>
                    </div>
                </div>
                <!--Rankings tables-->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-trophy-fill me-2"></i> Top 100 All Island
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Name</th>
                                                <th>Score</th>
                                                <th>School</th>
                                            </tr>
                                        </thead>
                                        <tbody id="overallRankings">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-people-fill me-2"></i> Top 100 by Class
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Name</th>
                                                <th>Score</th>
                                                <th>School</th>
                                            </tr>
                                        </thead>
                                        <tbody id="classRankings">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Stats Section -->
            <div id="statsSection" style="display: none;" class="fade-in">
    <h2 class="section-title">
        <i class="bi bi-graph-up me-2"></i> My Performance
    </h2>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="totalPapersTakenStat">0</div>
                            <div class="stat-label">Papers Taken</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-file-earmark-text stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="averageScoreStat">0%</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="bestRankStat">N/A</div>
                            <div class="stat-label">Best Rank</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-trophy stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card info">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="improvementStat">0%</div>
                            <div class="stat-label">Improvement</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-up-right stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-graph-up me-2"></i> Performance Trend
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- My Submissions Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-list-check me-2"></i> My Completed Papers
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="submissionFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-funnel me-1"></i> Filter
                </button>
                <ul class="dropdown-menu" aria-labelledby="submissionFilterDropdown">
                    <li><a class="dropdown-item active" href="#" data-filter="all">All Submissions</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="recent">Last 30 Days</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="top">Top Scores</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-filter="subject">By Subject</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Paper</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Class Rank</th>
                            <th>Overall Rank</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mySubmissionsTable">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            </div>
            </div>
            <!-- Paper Class Section -->
            <div id="paperClassSection" style="display: none;" class="fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title">
                        <i class="bi bi-journal-text me-2"></i> Paper Class Papers
                    </h2>
                </div>

                <ul class="nav nav-tabs mb-4" id="paperClassTabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="paperClassActive-tab" data-bs-toggle="tab" href="#paperClassActive">
                            Active Papers
                        </a>
                    </li>
                    <li class="nav-item">
                            <a class="nav-link" id="paperClassView-tab" data-bs-toggle="tab" href="#paperClassView">
                            View Papers
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Active Papers Tab -->
                    <div class="tab-pane fade show active" id="paperClassActive">
                        <div class="row" id="paperClassActivePapersContainer">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Loading active papers...</p>
                            </div>
                        </div>
                    </div>

                    <!-- View Papers Tab -->
                    <div class="tab-pane fade" id="paperClassView">
                        <div class="row" id="paperClassViewPapersContainer">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Loading papers...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Paper Class Rankings Section -->
            <div id="paperClassRankingsSection" style="display: none;" class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-title">
            <i class="bi bi-trophy me-2"></i> Paper Class Rankings
        </h2>
        <div class="filter-container">
            <select class="form-select" id="paperClassRankingsFilter">
                <option value="">All Papers</option>
                <!-- Papers will be loaded here -->
            </select>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-star-fill me-2"></i> All Island Top School
                </div>
                <div class="card-body">
                    <div id="paperClassOverallTopStudent" class="text-center py-3">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-award-fill me-2"></i> Class Top School
                </div>
                <div class="card-body">
                    <div id="paperClassClassTopStudent" class="text-center py-3">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="paperClassUserRankInfo" class="mb-4" style="display: none;">
        <div class="alert alert-success">
            <h5><i class="bi bi-trophy-fill me-2"></i> Your Rank</h5>
            <div id="paperClassUserRankDetails"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-trophy-fill me-2"></i> Top 100 All Island
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Score</th>
                                    <th>Class</th>
                                </tr>
                            </thead>
                            <tbody id="paperClassOverallRankings">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-people-fill me-2"></i> Top 100 by Class
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Score</th>
                                    <th>Class</th>
                                </tr>
                            </thead>
                            <tbody id="paperClassClassRankings">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>
            <!-- Paper Class Performance Section -->
            <div id="paperClassPerformanceSection" style="display: none;" class="fade-in">
    <h2 class="section-title">
        <i class="bi bi-graph-up-arrow me-2"></i> Paper Class Performance
    </h2>
    
    <div class="row mb-4">
        <!-- Summary Cards -->
        <div class="col-md-3">
            <div class="card stat-card primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="paperClassPapersTaken">0</div>
                            <div class="stat-label">Papers Attended</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-file-earmark-text stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="paperClassAverageScore">0%</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="paperClassLastScore">0%</div>
                            <div class="stat-label">Last Score</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-file-earmark-bar-graph stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card info">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="stat-value" id="paperClassImprovement">0%</div>
                            <div class="stat-label">Improvement</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-up-right stat-icon" id="improvementIcon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Overview Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-graph-up me-2"></i> Performance Trend
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="paperClassPerformanceChart" height="300"></canvas>
            </div>
        </div>
        <div class="card-footer">
            <button id="downloadChartBtn" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-download me-1"></i> Download Chart
            </button>
        </div>
    </div>
    

    <!-- Recent Papers Table -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-list-check me-2"></i> Recent Papers
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Paper</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Class Rank</th>
                            <th>Overall Rank</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paperClassRecentPapers">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>

    <!--Modals-->
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login to eWings-papers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="event.preventDefault();">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-primary">
                                <span id="loginSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                Login
                            </button>
                            <a href="registration.html" class="text-decoration-none">Don't have an account? Register</a>
                        </div>
                    </form>
                    <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">My Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profileName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="profileName" required>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profileNic" class="form-label">NIC Number</label>
                                    <input type="text" class="form-control" id="profileNic" disabled>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profileEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" disabled>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profileDistrict" class="form-label">District</label>
                                    <select class="form-select" id="profileDistrict" required>
                                        <option value="">Select District</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profileClass" class="form-label">Class</label>
                                    <select class="form-select" id="profileClass" required>
                                        <option value="">Select Class</option>
                                        <option value="Nugegoda">Nugegoda</option>
                                        <option value="Kandy">Kandy</option>
                                        <option value="Kegalle">Kegalle</option>
                                        <option value="Kurunegala">Kurunegala</option>
                                        <option value="Gall">Gall</option>
                                        <option value="Onlin">Online</option>
                                        <option value="All Island">All Island</option>
                                    </select>
                                </div>
                            </div>
                        
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profileSchool" class="form-label">School</label>
                                    <input type="text" class="form-control" id="profileSchool">
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profilePhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="profilePhone" required>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="profileYear" class="form-label">Registered Year</label>
                                    <select class="form-select" id="profileYear" required>
                                        <option value="">Select Year</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                    </select>
                                </div>
                            
                                <div id="profileClassTypeContainer" class="mb-3" style="display: none;">
                                    <label class="form-label">Class Types</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="profileTheory" name="profileClassType" value="Theory">
                                        <label class="form-check-label" for="profileTheory">Theory</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="profilePaperClass" name="profileClassType" value="Paper Class">
                                        <label class="form-check-label" for="profilePaperClass">Paper Class</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="profileRevision" name="profileClassType" value="Revision">
                                        <label class="form-check-label" for="profileRevision">Revision</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="profileOther" name="profileClassType" value="Other">
                                        <label class="form-check-label" for="profileOther">Other</label>
                                    </div>
                                </div>
                            
                                <div id="profileStudentIdContainer" class="mb-3" style="display: none;">
                                    <label for="profileStudentId" class="form-label">Student ID</label>
                                    <input type="text" class="form-control" id="profileStudentId" readonly>
                                    <small class="text-muted">Student ID cannot be changed once set</small>
                                </div>

                            </div>
                        </div>
                    
                        <div class="modal-footer">
                            <!-- Primary action -->
                            <button type="submit" class="btn btn-primary" id="profileSaveBtn">
                            <span id="profileSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                Save Changes
                            </button>
  
                            <!-- Secondary actions container -->
                            <div class="secondary-actions">
                                <button type="button" class="btn btn-outline-primary" id="changePasswordBtn">
                                    <i class="bi bi-key me-1"></i> Change Password
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                
                    <div id="profileError" class="alert alert-danger mt-3 d-none"></div>
                    <div id="profileSuccess" class="alert alert-success mt-3 d-none"></div>
                
                    <!-- Password Change Modal (hidden by default) -->
                    <div id="passwordChangeModal" class="mt-4" style="display: none;">
                        <hr>
                        <h5 class="mb-3"><i class="bi bi-key me-2"></i> Change Password</h5>
                        <form id="passwordChangeForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" required minlength="6">
                                <small class="text-muted">Minimum 6 characters</small>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-outline-secondary me-2" id="cancelPasswordChange">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" id="savePasswordBtn">
                                    <span id="passwordSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                    Update Password
                                </button>
                            </div>
                        </form>
                        <div id="passwordError" class="alert alert-danger mt-3 d-none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Details Modal -->
    <div class="modal fade" id="submissionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="submissionModalTitle">Submission Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="submissionDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadSubmissionBtn">
                    <i class="bi bi-download me-1"></i> Download Report
                </button>
            </div>
        </div>
    </div>
    </div>

    <!-- HTML template for the report (hidden) -->
    <div id="reportTemplate" style="display: none;">
    <div class="report-container">
        <div class="report-header">
            <h1 class="report-title">Performance Report</h1>
            <div class="report-meta">
                <p>Generated on: <span id="report-date"></span></p>
                <p>Student: <span id="report-student-name"></span></p>
            </div>
        </div>
        
        <div class="report-section">
            <h2 class="section-title">Submission Summary</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-value" id="report-paper-title"></div>
                    <div class="summary-label">Paper</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="report-score"></div>
                    <div class="summary-label">Score</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="report-rank"></div>
                    <div class="summary-label">Class Rank</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="report-overall-rank"></div>
                    <div class="summary-label">Overall Rank</div>
                </div>
            </div>
        </div>
        
        <div class="report-section">
            <h2 class="section-title">Performance Analysis</h2>
            <div class="chart-container">
                <canvas id="report-chart" width="800" height="300"></canvas>
            </div>
        </div>
        
        <div class="report-section">
            <h2 class="section-title">Question Breakdown</h2>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Your Answer</th>
                        <th>Correct Answer</th>
                        <th>Marks</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="report-questions">
                </tbody>
            </table>
        </div>
        
        <div class="report-footer">
            <p class="footer-note">This report was generated by eWings Papers System</p>
            <p class="footer-contact">Contact: info@ewings.com | Phone: +94 112 345 678</p>
        </div>
    </div>
    </div>

    <!-- Student Answers Modal -->
    <div class="modal fade" id="studentAnswersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your Paper Answers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="studentAnswersModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    </div>


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>

// Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDXV8VQFMxAWm82rB9BQzSxIl4CurqSE-E",
    authDomain: "ewings-papers.firebaseapp.com",
    projectId: "ewings-papers",
    storageBucket: "ewings-papers.firebasestorage.app",
    messagingSenderId: "924652224321",
    appId: "1:924652224321:web:3cbc45d55a7f2b80146bc0",
    measurementId: "G-2BMJBF9FK5"
  };

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// DOM elements
const authBtn = document.getElementById('authBtn');
const themeToggle = document.getElementById('themeToggle');
const yearFilter = document.getElementById('yearFilter');
const sidebar = document.getElementById('sidebar');
const content = document.getElementById('content');
const sidebarToggle = document.getElementById('sidebarToggle');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const welcomeMessage = document.getElementById('welcomeMessage');
const welcomeSubtext = document.getElementById('welcomeSubtext');
const sidebarUserName = document.getElementById('sidebarUserName');
const sidebarUserEmail = document.getElementById('sidebarUserEmail');

const sections = {
    dashboard: document.getElementById('dashboardSection'),
    papers: document.getElementById('papersSection'),
    ranks: document.getElementById('ranksSection'),
    stats: document.getElementById('statsSection'),
    paperClass: document.getElementById('paperClassSection'),
    paperClassRankings: document.getElementById('paperClassRankingsSection'),
    paperClassPerformance: document.getElementById('paperClassPerformanceSection')
};

const tabs = {
    dashboard: document.getElementById('dashboardTab'),
    papers: document.getElementById('papersTab'),
    ranks: document.getElementById('ranksTab'),
    stats: document.getElementById('statsTab'),
    paperClass: document.getElementById('paperClassTab'),
    paperClassRankings: document.getElementById('paperClassRankingsTab'),
    paperClassPerformance: document.getElementById('paperClassPerformanceTab')
};


// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    checkTheme();
    initAuthState();
    setupEventListeners();
    handleUrlParams();
    handleUrlParams();
    
    // Mobile menu toggle
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('toggled');
            content.classList.toggle('toggled');
        });
    }
    
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function() {
            sidebar.classList.toggle('toggled');
            content.classList.toggle('toggled');
        });
    }
    
    // Restore last viewed section if authenticated
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user) {
        const lastSection = localStorage.getItem('currentSection') || 'dashboard';
        showSection(lastSection);
    }
});

// Event listeners setup
function setupEventListeners() {
    // Theme toggle
    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    
    // Year filter
    if (yearFilter) {
        yearFilter.addEventListener('change', function() {
            loadPapers(this.value);
        });
    }
    
    // Tab navigation
    if (tabs.dashboard) tabs.dashboard.addEventListener('click', () => showSection('dashboard'));
    if (tabs.papers) tabs.papers.addEventListener('click', () => showSection('papers'));
if (tabs.ranks) {
    tabs.ranks.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('ranks');
        
        const paperFilter = document.getElementById('rankPaperFilter');
        if (!paperFilter || !paperFilter.value) {
            showPaperSelectionDialog();
        } else {
            loadRankings(paperFilter.value);
        }
    });
}
    if (tabs.stats) tabs.stats.addEventListener('click', () => {
        if (checkAuthForStats()) showSection('stats');
    });
    if (tabs.paperClass) tabs.paperClass.addEventListener('click', async () => {
    if (await checkAuthForPaperClass()) showSection('paperClass');
});

if (tabs.paperClassRankings) {
    tabs.paperClassRankings.addEventListener('click', async () => {
        if (await checkAuthForPaperClass()) showSection('paperClassRankings');
    });
}

if (tabs.paperClassPerformance) tabs.paperClassPerformance.addEventListener('click', async () => {
    if (await checkAuthForPaperClass()) showSection('paperClassPerformance');
});
    
    // Login form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
    }
    
    // Auth button
    if (authBtn) {
        authBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('currentUser'));
            
            if (user) {
                logoutUser();
            } else {
                const modal = new bootstrap.Modal(document.getElementById('loginModal'));
                modal.show();
            }
        });
    }

    const loginFromDashboardBtn = document.getElementById('loginFromDashboardBtn');
        if (loginFromDashboardBtn) {
        loginFromDashboardBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('loginModal'));
            modal.show();
        });
    }
    
    // Profile button in sidebar
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showProfileModal();
        });
    }
    
    // Logout button in sidebar
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            logoutUser();
        });
    }
}

// Authentication state management
function initAuthState() {
    auth.onAuthStateChanged(async user => {
        if (user) {
            try {
                const snapshot = await database.ref('users/' + user.uid).once('value');
                let userData = snapshot.val();
                
                if (!userData) {
                    // Initialize default user data if not found
                    userData = {
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        nic: '',
                        class: '',
                        registeredYear: new Date().getFullYear().toString(),
                        verified: false,
                        inactive: true,
                        isPaid: false,
                        classTypes: []
                    };
                    await database.ref('users/' + user.uid).set(userData);
                }
                
                // Ensure all fields are properly stored in localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    verified: userData.verified || false,
                    inactive: userData.inactive || true,
                    isPaid: userData.isPaid || false,
                    classTypes: userData.classTypes || [],
                    ...userData
                }));
                
                updateUserUI(user, userData);
                loadInitialContent(userData.registeredYear);
                
            } catch (error) {
                console.error("Error handling user data:", error);
                showToast("Error loading your account", 'danger');
                logoutUser();
            }
        } else {
            showPublicContent();
            localStorage.removeItem('currentUser');
        }
    });
}

function updateUserUI(user, userData) {
    const userObj = {
        uid: user.uid,
        email: user.email,
        name: userData.name,
        nic: userData.nic,
        class: userData.class,
        district: userData.district,
        school: userData.school,
        phone: userData.phone,
        classTypes: userData.classTypes,
        studentId: userData.studentId,
        registeredYear: userData.registeredYear
    };
    
    localStorage.setItem('currentUser', JSON.stringify(userObj));

    // Show/hide dashboard and profile sections based on auth state
    const dashboardNavItem = document.getElementById('dashboardNavItem');
    const accountNavItems = document.getElementById('accountNavItems');
    const dashboardTab = document.getElementById('dashboardTab');
    
    if (user) {
        if (dashboardNavItem) dashboardNavItem.style.display = 'block';
        if (accountNavItems) accountNavItems.style.display = 'block';
        if (dashboardTab) dashboardTab.classList.add('active');
    } else {
        if (dashboardNavItem) dashboardNavItem.style.display = 'none';
        if (accountNavItems) accountNavItems.style.display = 'none';
        if (dashboardTab) dashboardTab.classList.remove('active');
    }

    // Update welcome message
    if (welcomeMessage) {
        welcomeMessage.textContent = `Welcome back, ${userData.name || 'Student'}!`;
    }
    
    if (welcomeSubtext) {
        welcomeSubtext.textContent = `Ready to ace your next paper?`;
    }
    
    // Update sidebar user info
    if (sidebarUserName) {
        sidebarUserName.textContent = userData.name || 'User';
    }
    
    if (sidebarUserEmail) {
        sidebarUserEmail.textContent = user.email;
    }

    // Replace auth button with profile dropdown
    if (authBtn && authBtn.parentElement) {
        authBtn.innerHTML = `
            <i class="bi bi-person-circle me-2"></i>
            ${userData.name || 'User'}
        `;
        authBtn.classList.remove('btn-outline-light');
        authBtn.classList.add('btn-success');
    }
    
    // Enable protected sections
    if (tabs.stats) tabs.stats.classList.remove('disabled');
    if (tabs.ranks) tabs.ranks.classList.remove('disabled');
    
    // Update profile modal fields if it's open
    if (document.getElementById('profileModal')?.classList.contains('show')) {
        document.getElementById('profileName').value = userData.name || '';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profileNic').value = userData.nic || '';
        document.getElementById('profileClass').value = userData.class || '';
        document.getElementById('profileYear').value = userData.registeredYear || '';
    }
}

function showProfileModal() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) return;

    const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
    
    // Populate form fields
    document.getElementById('profileName').value = user.name || '';
    document.getElementById('profileNic').value = user.nic || '';
    document.getElementById('profileEmail').value = user.email || '';
    document.getElementById('profileSchool').value = user.school || '';
    document.getElementById('profilePhone').value = user.phone || '';
    
    // Set district
    const districtSelect = document.getElementById('profileDistrict');
    districtSelect.innerHTML = '<option value="">Select District</option>';
    // Add all district options
    const districts = ["Ampara", "Anuradhapura", "Badulla", "Batticaloa", "Colombo", 
                      "Galle", "Gampaha", "Hambantota", "Jaffna", "Kalutara", 
                      "Kandy", "Kegalle", "Kilinochchi", "Kurunegala", "Mannar", 
                      "Matale", "Matara", "Monaragala", "Mullaitivu", "Nuwara Eliya", 
                      "Polonnaruwa", "Puttalam", "Ratnapura", "Trincomalee", "Vavuniya"];
    
    districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        option.selected = (district === user.district);
        districtSelect.appendChild(option);
    });
    
    // Set class
    document.getElementById('profileClass').value = user.class || '';
    
    // Set year
    document.getElementById('profileYear').value = user.registeredYear || '';
    
    // Handle class types
    const classTypeContainer = document.getElementById('profileClassTypeContainer');
    const studentIdContainer = document.getElementById('profileStudentIdContainer');
    const studentIdField = document.getElementById('profileStudentId');
    
    if (user.class && user.class !== 'All Island') {
        classTypeContainer.style.display = 'block';
        
        // Set class types and disable already selected ones
        if (user.classTypes && user.classTypes.length > 0) {
            user.classTypes.forEach(type => {
                const checkbox = document.querySelector(`input[name="profileClassType"][value="${type}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.disabled = true;
                    
                    // Add visual indication that this can't be changed
                    const label = checkbox.nextElementSibling;
                    if (label) {
                        label.classList.add('text-muted');
                        label.title = "This selection cannot be changed";
                    }
                }
            });
        }
        
        // Set student ID if exists
        if (user.studentId) {
            studentIdContainer.style.display = 'block';
            studentIdField.value = user.studentId;
            studentIdField.readOnly = true;
        } else {
            // Only show student ID field if Paper Class or Revision is selected
            const paperClassChecked = document.getElementById('profilePaperClass').checked;
            const revisionChecked = document.getElementById('profileRevision').checked;
            studentIdContainer.style.display = (paperClassChecked || revisionChecked) ? 'block' : 'none';
            studentIdField.readOnly = false;
        }
    } else {
        classTypeContainer.style.display = 'none';
        studentIdContainer.style.display = 'none';
    }
    
    // Handle class selection change
    document.getElementById('profileClass').addEventListener('change', function() {
        if (this.value === 'All Island') {
            classTypeContainer.style.display = 'none';
            studentIdContainer.style.display = 'none';
        } else {
            classTypeContainer.style.display = 'block';
            
            // Check if student ID exists - if yes, show it as readonly
            if (user.studentId) {
                studentIdContainer.style.display = 'block';
                studentIdField.value = user.studentId;
                studentIdField.readOnly = true;
            } else {
                // Show only if Paper Class or Revision is selected
                const paperClassChecked = document.getElementById('profilePaperClass').checked;
                const revisionChecked = document.getElementById('profileRevision').checked;
                studentIdContainer.style.display = (paperClassChecked || revisionChecked) ? 'block' : 'none';
                studentIdField.readOnly = false;
            }
        }
    });
    
    // Handle class type checkbox changes
    document.querySelectorAll('input[name="profileClassType"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (user.classTypes && user.classTypes.includes(this.value) && !this.checked) {
                // Prevent unchecking if it's already in user's profile
                this.checked = true;
                showProfileError('You cannot remove this class type once selected');
                return;
            }
            
            if (!user.studentId) {
                const paperClassChecked = document.getElementById('profilePaperClass').checked;
                const revisionChecked = document.getElementById('profileRevision').checked;
                studentIdContainer.style.display = (paperClassChecked || revisionChecked) ? 'block' : 'none';
            }
        });
    });
    
    // Reset password change section
    document.getElementById('passwordChangeModal').style.display = 'none';
    document.getElementById('passwordChangeForm').reset();
    document.getElementById('passwordError').classList.add('d-none');
    
    // Reset status messages
    document.getElementById('profileError').classList.add('d-none');
    document.getElementById('profileSuccess').classList.add('d-none');
    
    profileModal.show();
}

// Handle profile form submission
document.getElementById('profileForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) return;
    
    // Show loading state
    const saveBtn = document.getElementById('profileSaveBtn');
    const spinner = document.getElementById('profileSpinner');
    saveBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    // Get form values
    const name = document.getElementById('profileName').value.trim();
    const district = document.getElementById('profileDistrict').value;
    const studentClass = document.getElementById('profileClass').value;
    const school = document.getElementById('profileSchool').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const year = document.getElementById('profileYear').value;
    
    // Get class types
    const classTypeContainer = document.getElementById('profileClassTypeContainer');
    const showClassType = classTypeContainer.style.display !== 'none';
    let classTypes = [];
    let studentId = user.studentId || ''; // Keep existing ID if it exists
    
    if (showClassType) {
        const classTypeCheckboxes = document.querySelectorAll('input[name="profileClassType"]:checked');
        classTypes = Array.from(classTypeCheckboxes).map(cb => cb.value);
        
        // If Paper Class or Revision is selected and no student ID exists, generate one
        const paperClassChecked = document.getElementById('profilePaperClass').checked;
        const revisionChecked = document.getElementById('profileRevision').checked;
        
        if ((paperClassChecked || revisionChecked) && !user.studentId) {
            // Generate a new student ID if none exists
            studentId = `${studentClass.substring(0, 3).toUpperCase()}${Date.now().toString().slice(-6)}`;
        }
    }
    
    // Validate form
    let isValid = true;
    
    if (name.length < 3) {
        showProfileError('Name must be at least 3 characters');
        isValid = false;
    }
    
    if (!district) {
        showProfileError('Please select a district');
        isValid = false;
    }
    
    if (!studentClass) {
        showProfileError('Please select a class');
        isValid = false;
    }
    
    if (!phone) {
        showProfileError('Please enter a phone number');
        isValid = false;
    }
    
    if (!year) {
        showProfileError('Please select a year');
        isValid = false;
    }
    
    if (!isValid) {
        saveBtn.disabled = false;
        spinner.classList.add('d-none');
        return;
    }
    
    try {
        // Prepare updated user data
        const updatedData = {
            name: name,
            district: district,
            class: studentClass,
            school: school || '',
            phone: phone,
            registeredYear: year,
            classTypes: showClassType ? classTypes : [],
            studentId: studentId // This will either keep the existing ID or set a new one
        };
        
        // Update user data in database
        await database.ref('users/' + user.uid).update(updatedData);
        
        // Update local storage
        const updatedUser = { ...user, ...updatedData };
        localStorage.setItem('currentUser', JSON.stringify(updatedUser));
        
        // Update sidebar display
        updateUserUI(auth.currentUser, updatedData);
        
        // Show success message
        showProfileSuccess('Profile updated successfully!');
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showProfileError('Failed to update profile. Please try again.');
    } finally {
        saveBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});

// Handle class type checkbox changes
function setupClassTypeCheckboxes() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) return;

    const checkboxes = document.querySelectorAll('input[name="profileClassType"]');
    
    checkboxes.forEach(checkbox => {
        // Disable checkboxes that are already selected in user's profile
        if (user.classTypes && user.classTypes.includes(checkbox.value)) {
            checkbox.disabled = true;
            checkbox.checked = true;
            
            // Add a visual indicator that this can't be changed
            const label = checkbox.nextElementSibling;
            if (label) {
                label.classList.add('text-muted');
                label.title = "This selection cannot be changed";
            }
        }
        
        checkbox.addEventListener('change', function() {
            const paperClassChecked = document.getElementById('profilePaperClass').checked;
            const revisionChecked = document.getElementById('profileRevision').checked;
            const studentIdContainer = document.getElementById('profileStudentIdContainer');
            
            // If either Paper Class or Revision is checked and no student ID exists, show the container
            if ((paperClassChecked || revisionChecked) && !user.studentId) {
                studentIdContainer.style.display = 'block';
            } else {
                studentIdContainer.style.display = 'none';
            }
            
            // Prevent unchecking if it's already in user's profile
            if (user.classTypes && user.classTypes.includes(this.value) && !this.checked) {
                this.checked = true;
                showProfileError('You cannot remove this class type once selected');
            }
        });
    });
}

// Handle password change
document.getElementById('changePasswordBtn')?.addEventListener('click', function() {
    document.getElementById('passwordChangeModal').style.display = 'block';
    document.getElementById('passwordError').classList.add('d-none');
});

document.getElementById('cancelPasswordChange')?.addEventListener('click', function() {
    document.getElementById('passwordChangeModal').style.display = 'none';
    document.getElementById('passwordChangeForm').reset();
    document.getElementById('passwordError').classList.add('d-none');
});

document.getElementById('passwordChangeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return;
    
    // Show loading state
    const saveBtn = document.getElementById('savePasswordBtn');
    const spinner = document.getElementById('passwordSpinner');
    saveBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    // Get form values
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Validate form
    let isValid = true;
    
    if (newPassword.length < 6) {
        showPasswordError('New password must be at least 6 characters');
        isValid = false;
    }
    
    if (newPassword !== confirmPassword) {
        showPasswordError('Passwords do not match');
        isValid = false;
    }
    
    if (!isValid) {
        saveBtn.disabled = false;
        spinner.classList.add('d-none');
        return;
    }
    
    try {
        // Reauthenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(
            user.email, 
            currentPassword
        );
        
        await user.reauthenticateWithCredential(credential);
        
        // Update password
        await user.updatePassword(newPassword);
        
        // Show success message
        showProfileSuccess('Password updated successfully!');
        
        // Hide password change form
        document.getElementById('passwordChangeModal').style.display = 'none';
        document.getElementById('passwordChangeForm').reset();
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        let errorMessage = 'Failed to change password. Please try again.';
        if (error.code === 'auth/wrong-password') {
            errorMessage = 'Current password is incorrect';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'New password is too weak';
        }
        
        showPasswordError(errorMessage);
    } finally {
        saveBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});

// Helper functions for showing messages
function showProfileError(message) {
    const errorElement = document.getElementById('profileError');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
    errorElement.classList.add('show');
    
    setTimeout(() => {
        errorElement.classList.remove('show');
        setTimeout(() => errorElement.classList.add('d-none'), 300);
    }, 5000);
}

function showProfileSuccess(message) {
    const successElement = document.getElementById('profileSuccess');
    successElement.textContent = message;
    successElement.classList.remove('d-none');
    successElement.classList.add('show');
    
    setTimeout(() => {
        successElement.classList.remove('show');
        setTimeout(() => successElement.classList.add('d-none'), 300);
    }, 5000);
}

function showPasswordError(message) {
    const errorElement = document.getElementById('passwordError');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
    errorElement.classList.add('show');
    
    setTimeout(() => {
        errorElement.classList.remove('show');
        setTimeout(() => errorElement.classList.add('d-none'), 300);
    }, 5000);
}

function logoutUser(e) {
    if (e) {
        e.preventDefault();
        if (!confirm('Are you sure you want to log out?')) return;
    }
    
    // Show loading state
    const authBtn = document.getElementById('authBtn');
    if (authBtn) {
        authBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span>
            Logging out...
        `;
        authBtn.disabled = true;
    }
    
    auth.signOut().then(() => {
        localStorage.removeItem('currentUser');
        showPublicContent();
        showToast('Logged out successfully', 'success');
        // Force refresh to ensure clean state
        setTimeout(() => location.reload(), 1000);
    }).catch(error => {
        console.error('Logout error:', error);
        showToast('Logout failed. Please try again.', 'danger');
        if (authBtn) {
            authBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i> Logout';
            authBtn.disabled = false;
        }
    });
}

function showPublicContent() {
    // Hide dashboard and profile sections
    const dashboardNavItem = document.getElementById('dashboardNavItem');
    const accountNavItems = document.getElementById('accountNavItems');
    const dashboardTab = document.getElementById('dashboardTab');
    
    if (dashboardNavItem) dashboardNavItem.style.display = 'none';
    if (accountNavItems) accountNavItems.style.display = 'none';
    if (dashboardTab) dashboardTab.classList.remove('active');

    // Reset auth button
    if (authBtn) {
        authBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i> Login';
        authBtn.classList.remove('btn-success');
        authBtn.classList.add('btn-outline-light');
        authBtn.disabled = false;
    }

    // Reset welcome message
    if (welcomeMessage) {
        welcomeMessage.textContent = 'Welcome to eWings-papers';
    }
    
    if (welcomeSubtext) {
        welcomeSubtext.textContent = 'Please login to access your papers and performance data';
    }
    
    // Reset sidebar user info
    if (sidebarUserName) {
        sidebarUserName.textContent = 'Welcome';
    }
    
    if (sidebarUserEmail) {
        sidebarUserEmail.textContent = 'Please login';
    }

    // Disable protected sections
    if (tabs.stats) tabs.stats.classList.add('disabled');
    if (tabs.ranks) tabs.ranks.classList.add('disabled');
    
    // Reset dashboard content if it's visible
    const dashboardContent = document.getElementById('dashboardContent');
    if (dashboardContent) {
        dashboardContent.style.display = 'none';
    }
    const dashboardAuthCheck = document.getElementById('dashboardAuthCheck');
    if (dashboardAuthCheck) {
        dashboardAuthCheck.style.display = 'block';
    }
    
    // Load public content (papers)
    loadPapers();
    
    // Close any open modals
    const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
    if (profileModal) profileModal.hide();
    
    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
    if (loginModal) loginModal.hide();
    
    // Show login prompt if trying to access protected sections
    if (window.location.hash === '#dashboard' || 
        window.location.hash === '#stats' || 
        window.location.hash === '#ranks') {
        const modal = new bootstrap.Modal(document.getElementById('loginModal'));
        modal.show();
    }
}

function loadInitialContent(userYear) {
    showSection('dashboard');
    if (userYear && yearFilter) {
        yearFilter.value = userYear;
        // Add small delay to ensure UI is ready
        setTimeout(() => loadPapers(userYear), 300);
    } else {
        loadPapers();
    }
}

function showSection(section) {
    // Hide all sections and remove active class from all tabs
    Object.values(sections).forEach(sec => {
        if (sec) {
            sec.style.display = 'none';
            sec.classList.remove('fade-in');
        }
    });
    
    Object.values(tabs).forEach(tab => {
        if (tab) tab.classList.remove('active');
    });
    
    // Show the selected section and mark tab as active
    if (sections[section]) {
        sections[section].style.display = 'block';
        setTimeout(() => sections[section].classList.add('fade-in'), 10);
    }
    if (tabs[section]) tabs[section].classList.add('active');
    
    // Always show dashboard tab in sidebar when logged in
    const user = JSON.parse(localStorage.getItem('currentUser'));
    const dashboardTab = document.getElementById('dashboardTab');
    if (dashboardTab && user) {
        dashboardTab.style.display = 'block';
    }
    
    // Store the current section in localStorage
    localStorage.setItem('currentSection', section);
    
    // Load section-specific data
    if (section === 'dashboard') loadDashboardData();
    else if (section === 'papers') loadPapers(yearFilter?.value);
    else if (section === 'ranks') loadPapersForRankings();
    else if (section === 'stats' && checkAuthForStats()) loadUserStats();
    else if (section === 'paperClass' && checkAuthForPaperClass()) loadPaperClassPapers();
    else if (section === 'paperClassRankings' && checkAuthForPaperClassRankings()) loadPaperClassRankings();
    else if (section === 'paperClassPerformance' && checkAuthForPaperClass()) loadPaperClassPerformance();
}

// Dashboard functions
async function loadDashboardData() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    const authCheck = document.getElementById('dashboardAuthCheck');
    const dashboardContent = document.getElementById('dashboardContent');
    
    // Check authentication
    if (!user) {
        if (authCheck) authCheck.style.display = 'block';
        if (dashboardContent) dashboardContent.style.display = 'none';
        
        // Login from dashboard button
        const loginFromDashboardBtn = document.getElementById('loginFromDashboardBtn');
        if (loginFromDashboardBtn) {
            loginFromDashboardBtn.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('loginModal'));
                modal.show();
            });
        }
        return;
    }
    
    // User is authenticated - show dashboard content
    if (authCheck) authCheck.style.display = 'none';
    if (dashboardContent) dashboardContent.style.display = 'block';
    
    try {
        // Show loading state
        document.getElementById('totalPapersTaken').textContent = '...';
        document.getElementById('averageScore').textContent = '...';
        document.getElementById('bestRank').textContent = '...';
        document.getElementById('improvementRate').textContent = '...';
        
        const [papersSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref('papers').once('value'),
            database.ref('submissions').once('value')
        ]);
        
        const papers = papersSnapshot.val() || {};
        const allSubmissions = submissionsSnapshot.val() || {};
        const userSubmissions = [];
        
        // Process all submissions to find the user's submissions using NIC
        Object.entries(allSubmissions).forEach(([paperId, paperSubmissions]) => {
            if (paperSubmissions && papers[paperId]) {
                // Find submission by NIC
                const submission = paperSubmissions[user.nic];
                if (submission) {
                    userSubmissions.push({
                        paperId,
                        paperTitle: papers[paperId].title,
                        paperYear: papers[paperId].year,
                        score: submission.score || 0,
                        totalMarks: submission.totalPossible || papers[paperId].totalMarks || 100,
                        rank: submission.rank || 'N/A',
                        timestamp: submission.timestamp || Date.now()
                    });
                }
            }
        });
        
        // Sort by timestamp (newest first)
        userSubmissions.sort((a, b) => b.timestamp - a.timestamp);
        
        // Update dashboard stats
        updateDashboardStats(userSubmissions);
        
        // Initialize performance overview chart
        initializePerformanceOverviewChart(userSubmissions);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        
        // Show error state in UI
        document.getElementById('totalPapersTaken').textContent = 'Error';
        document.getElementById('averageScore').textContent = 'Error';
        document.getElementById('bestRank').textContent = 'Error';
        document.getElementById('improvementRate').textContent = 'Error';
        
        showToast('Failed to load dashboard data', 'danger');
    }
    updateDashboardSections();
}
document.getElementById('viewAllPapersBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    showSection('papers');
});

async function updateDashboardSections() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) return;

    try {
        // Get user's registered year
        const registeredYear = user.registeredYear || new Date().getFullYear().toString();
        
        // Get all papers and submissions
        const [papersSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref('papers').once('value'),
            database.ref('submissions').once('value')
        ]);
        
        const papers = papersSnapshot.val() || {};
        const allSubmissions = submissionsSnapshot.val() || {};
        
        // Process user's submissions
        let userSubmissions = [];
        Object.entries(allSubmissions).forEach(([paperId, paperSubmissions]) => {
            if (paperSubmissions && papers[paperId]) {
                const submission = paperSubmissions[user.nic];
                if (submission) {
                    userSubmissions.push({
                        paperId,
                        paperTitle: papers[paperId].title,
                        paperYear: papers[paperId].year,
                        score: submission.score || 0,
                        totalMarks: submission.totalPossible || papers[paperId].totalMarks || 100,
                        rank: submission.rank || 'N/A',
                        timestamp: submission.timestamp || Date.now()
                    });
                }
            }
        });
        
        // Sort by timestamp (newest first)
        userSubmissions.sort((a, b) => b.timestamp - a.timestamp);
        
        // Update dashboard stats
        updateDashboardStats(userSubmissions);
        
        // Initialize performance chart
        initializePerformanceOverviewChart(userSubmissions);
        
        // Update Latest Paper Top 10
        updateLatestPaperTop10(papers, allSubmissions, registeredYear);
        
        // Update Recent Activity
        updateRecentActivity(userSubmissions);
        
        // Update New Papers
        updateNewPapers(papers, registeredYear);
        
    } catch (error) {
        console.error('Error updating dashboard sections:', error);
        showToast('Failed to load dashboard data', 'danger');
    }
}

function updateLatestPaperTop10(papers, allSubmissions, year) {
    // Find the most recent paper for the user's registered year
    let latestPaper = null;
    let latestPaperId = null;
    let latestTimestamp = 0;
    
    Object.entries(papers).forEach(([paperId, paper]) => {
        if (paper.year === year) {
            const closeTime = new Date(paper.closeTime).getTime();
            if (closeTime > latestTimestamp) {
                latestTimestamp = closeTime;
                latestPaper = paper;
                latestPaperId = paperId;
            }
        }
    });
    
    if (!latestPaperId) {
        document.getElementById('latestPaperTop10').innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4">
                    No papers found for ${year}
                </td>
            </tr>
        `;
        return;
    }
    
    // Get submissions for this paper
    const paperSubmissions = allSubmissions[latestPaperId] || {};
    let submissionsArray = Object.entries(paperSubmissions).map(([nic, sub]) => ({
        nic,
        name: sub.name || 'Anonymous',
        score: sub.score || 0,
        totalMarks: sub.totalPossible || latestPaper.totalMarks || 100,
        percentage: sub.score && sub.totalPossible ? 
            Math.round((sub.score / sub.totalPossible) * 100) : 0
    }));
    
    // Sort by score (descending) and take top 10
    submissionsArray.sort((a, b) => b.score - a.score);
    const top10 = submissionsArray.slice(0, 10);
    
    // Update the table
    const tableBody = document.getElementById('latestPaperTop10');
    if (top10.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4">
                    No submissions yet for ${latestPaper.title}
                </td>
            </tr>
        `;
    } else {
        tableBody.innerHTML = top10.map((sub, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${sub.name}</td>
                <td>${sub.score}/${sub.totalMarks} (${sub.percentage}%)</td>
            </tr>
        `).join('');
    }
}

function updateNewPapers(papers, year) {
    const now = Date.now();
    const newPapersContainer = document.getElementById('newPapersList');
    
    // Filter papers for the user's registered year that are upcoming or recently opened
    const newPapers = Object.entries(papers)
        .filter(([id, paper]) => paper.year === year)
        .filter(([id, paper]) => {
            const openTime = new Date(paper.openTime).getTime();
            return openTime > now || (openTime <= now && openTime > now - 30*24*60*60*1000); // Within last 30 days
        })
        .sort((a, b) => new Date(b[1].openTime) - new Date(a[1].openTime))
        .slice(0, 3); // Show only 3 newest papers
    
    if (newPapers.length === 0) {
        newPapersContainer.innerHTML = `
            <div class="col-12 text-center py-4">
                No new papers available
            </div>
        `;
        return;
    }
    
    newPapersContainer.innerHTML = newPapers.map(([id, paper]) => {
        const openDate = new Date(paper.openTime);
        const closeDate = new Date(paper.closeTime);
        const isAvailable = now >= openDate.getTime() && now <= closeDate.getTime();
        
        return `
            <div class="col-md-4">
                <div class="card paper-card">
                    <div class="card-body">
                        <h5 class="card-title">${paper.title}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${paper.year} - ${paper.subject}</h6>
                        <p class="card-text text-muted small">
                            ${isAvailable ? 'Available until' : 'Opens on'} 
                            ${isAvailable ? closeDate.toLocaleDateString() : openDate.toLocaleDateString()}
                        </p>
                        ${isAvailable ? `
                            <a href="student-paper.html?paperId=${id}" class="btn btn-primary w-100">
                                <i class="bi bi-pencil-square me-1"></i> Attend Now
                            </a>
                        ` : `
                            <button class="btn btn-outline-secondary w-100" disabled>
                                <i class="bi bi-send-slash"></i> Closed 
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}



// Helper function to update dashboard stats cards
async function updateDashboardStats(submissions) {
    if (submissions.length === 0) {
        document.getElementById('totalPapersTaken').textContent = '0';
        document.getElementById('averageScore').textContent = '0%';
        document.getElementById('bestRank').textContent = 'N/A';
        document.getElementById('improvementRate').textContent = '0%';
        return;
    }

    // Total Papers Taken
    document.getElementById('totalPapersTaken').textContent = submissions.length;
    
    // Average Score
    const totalScore = submissions.reduce((sum, sub) => sum + sub.score, 0);
    const totalPossible = submissions.reduce((sum, sub) => sum + (sub.totalMarks || 100), 0);
    const averagePercentage = totalPossible > 0 ? ((totalScore / totalPossible) * 100).toFixed(1) : 0;
    document.getElementById('averageScore').textContent = `${averagePercentage}%`;
    
    // Best Rank
    const validRanks = submissions.filter(sub => typeof sub.rank === 'number' && !isNaN(sub.rank));
    const bestRank = validRanks.length > 0 ? Math.min(...validRanks.map(sub => sub.rank)) : 'N/A';
    document.getElementById('bestRank').textContent = bestRank;
    
    // Improvement Rate (compare last two papers)
    if (submissions.length >= 2) {
        const lastPaper = submissions[0]; // Most recent
        const prevPaper = submissions[1]; // Previous
        
        const lastScore = lastPaper.score / lastPaper.totalMarks;
        const prevScore = prevPaper.score / prevPaper.totalMarks;
        
        const improvement = prevScore > 0 ? ((lastScore - prevScore) / prevScore * 100).toFixed(1) : 'N/A';
        document.getElementById('improvementRate').textContent = 
            typeof improvement === 'string' ? improvement : `${improvement}%`;
    } else {
        document.getElementById('improvementRate').textContent = 'N/A';
    }
    
    // Add class average comparison
    const classAverages = await Promise.all(
        submissions.map(async sub => {
            return await calculateClassAverage(sub.paperId);
        })
    );
    
    const overallClassAverage = classAverages.reduce((sum, avg) => sum + avg, 0) / classAverages.length;
    const userAverage = parseFloat(averagePercentage);
    
    
}

async function initializePerformanceOverviewChart(submissions) {
    const ctx = document.getElementById('performanceOverviewChart');
    if (!ctx) return;
    
    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    try {
        // Sort submissions chronologically for the chart
        const sortedSubmissions = [...submissions].sort((a, b) => a.timestamp - b.timestamp);
        
        // Get class averages for each submission
        const classAverages = await Promise.all(
            sortedSubmissions.map(async sub => {
                return await calculateClassAverage(sub.paperId);
            })
        );
        
        ctx.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedSubmissions.map(sub => {
                    const date = new Date(sub.timestamp);
                    return `${date.getDate()}/${date.getMonth()+1}`;
                }),
                datasets: [
                    {
                        label: 'Your Score (%)',
                        data: sortedSubmissions.map(sub => 
                            Math.round((sub.score / (sub.totalMarks || 100)) * 100)
                        ),
                        borderColor: 'rgba(78, 115, 223, 1)',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    },
                    {
                        label: 'Class Average (%)',
                        data: classAverages,
                        borderColor: 'rgba(28, 200, 138, 1)',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        tension: 0.3,
                        borderDash: [5, 5],
                        borderWidth: 2
                    },
                    {
                        label: 'Top Score (%)',
                        data: await Promise.all(
                            sortedSubmissions.map(async sub => {
                                return await calculateTopScore(sub.paperId);
                            })
                        ),
                        borderColor: 'rgba(246, 194, 62, 1)',
                        backgroundColor: 'rgba(246, 194, 62, 0.1)',
                        tension: 0.3,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Score (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Submission Date'
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error initializing chart:', error);
    }
}

//helper function 
async function getClassPerformanceData(paperId, userClass) {
    try {
        // Get all submissions for this paper
        const snapshot = await database.ref(`submissions/${paperId}`).once('value');
        const submissions = snapshot.val() || {};
        
        // Convert to array
        let submissionsArray = Object.values(submissions);
        
        // Filter by class if specified
        if (userClass) {
            submissionsArray = submissionsArray.filter(sub => sub.class === userClass);
        }
        
        if (submissionsArray.length === 0) {
            return {
                average: 0,
                median: 0,
                topScore: 0,
                bottomScore: 0,
                count: 0
            };
        }
        
        // Calculate statistics
        const percentages = submissionsArray.map(sub => {
            const totalPossible = sub.totalPossible || 100;
            return (sub.score / totalPossible) * 100;
        }).sort((a, b) => a - b);
        
        const average = percentages.reduce((sum, p) => sum + p, 0) / percentages.length;
        const median = calculateMedian(percentages);
        const topScore = percentages[percentages.length - 1];
        const bottomScore = percentages[0];
        
        return {
            average: Math.round(average),
            median: Math.round(median),
            topScore: Math.round(topScore),
            bottomScore: Math.round(bottomScore),
            count: percentages.length
        };
    } catch (error) {
        console.error('Error getting class performance data:', error);
        return {
            average: 0,
            median: 0,
            topScore: 0,
            bottomScore: 0,
            count: 0
        };
    }
}

function calculateMedian(values) {
    if (values.length === 0) return 0;
    
    values.sort((a, b) => a - b);
    const half = Math.floor(values.length / 2);
    
    if (values.length % 2) {
        return values[half];
    }
    
    return (values[half - 1] + values[half]) / 2;
}

function updateRecentActivity(submissions) {
    const activityList = document.getElementById('recentActivityList');
    if (submissions.length === 0) {
        activityList.innerHTML = `
            <div class="text-center py-4">
                No recent activity
            </div>
        `;
        return;
    }
    
    // Show only the 5 most recent submissions
    const recentSubmissions = submissions.slice(0, 5);
    
    activityList.innerHTML = recentSubmissions.map(sub => {
        const date = new Date(sub.timestamp);
        const percentage = Math.round((sub.score / sub.totalMarks) * 100);
        
        return `
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="mb-1">${sub.paperTitle}</h6>
                        <small class="text-muted">
                            ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary rounded-pill">
                            ${percentage}%
                        </span>
                        <div class="small text-muted">
                            Rank: ${sub.rank || 'N/A'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Paper management functions
function loadPapers(selectedYear = '') {
    const availablePapers = document.getElementById('availablePapers');
    const viewAnswers = document.getElementById('viewAnswers');
    
    if (availablePapers) {
        availablePapers.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary"></div>
            </div>
        `;
    }
    
    if (viewAnswers) {
        viewAnswers.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary"></div>
            </div>
        `;
    }
    
    database.ref('papers').once('value').then(snapshot => {
        const papers = snapshot.val() || {};
        const now = Date.now();
        
        let availableHtml = '';
        let answersHtml = '';
        let hasAvailable = false;
        let hasAnswers = false;
        
        Object.entries(papers).forEach(([id, paper]) => {
            if (selectedYear && paper.year !== selectedYear) return;
            
            const card = createPaperCard(id, paper);
            const openTime = new Date(paper.openTime).getTime();
            const closeTime = new Date(paper.closeTime).getTime();
            
            if (now >= openTime && now <= closeTime) {
                availableHtml += card;
                hasAvailable = true;
            } else if (now > closeTime) {
                answersHtml += card;
                hasAnswers = true;
            }
        });
        
        if (availablePapers) {
            availablePapers.innerHTML = hasAvailable ? availableHtml : 
                '<div class="col-12 text-center py-4">No available papers</div>';
        }
        
        if (viewAnswers) {
            viewAnswers.innerHTML = hasAnswers ? answersHtml : 
                '<div class="col-12 text-center py-4">No papers with answers</div>';
        }
        
        addPaperCardEventListeners();
    }).catch(error => {
        console.error('Error loading papers:', error);
        if (availablePapers) {
            availablePapers.innerHTML = '<div class="col-12 text-center py-4 text-danger">Error loading papers</div>';
        }
    });
}

function createPaperCard(id, paper) {
    const isAvailable = isPaperAvailable(paper);
    const isClosed = isPaperClosed(paper);
    
    let buttons = '';
    if (isAvailable) {
        buttons = `
            <div class="btn-group w-100 mb-2">
                <button class="btn btn-outline-primary download-paper-btn" data-id="${id}" data-medium="sinhala">
                    <i class="bi bi-download me-1"></i> Sinhala
                </button>
                <button class="btn btn-outline-primary download-paper-btn" data-id="${id}" data-medium="english">
                    <i class="bi bi-download me-1"></i> English
                </button>
            </div>
            <a href="student-paper.html?paperId=${id}" target="_blank" class="btn btn-primary w-100 attend-paper-btn" 
               data-id="${id}"
               data-debug="true"
               onclick="console.log('Button onclick fired for ${id}')">
                <i class="bi bi-pencil-square me-1"></i> Attend Now
            </a>
        `;
    } else if (isClosed) {
        buttons = `
            <div class="btn-group w-100 mb-2">
                <button class="btn btn-outline-primary download-paper-btn" data-id="${id}" data-medium="sinhala">
                    <i class="bi bi-download me-1"></i> Sinhala
                </button>
                <button class="btn btn-outline-primary download-paper-btn" data-id="${id}" data-medium="english">
                    <i class="bi bi-download me-1"></i> English
                </button>
            </div>
            <div class="btn-group w-100">
                <button class="btn btn-outline-success download-answers-btn" data-id="${id}">
                    <i class="bi bi-file-earmark-text me-1"></i> Answers
                </button>
                <button class="btn btn-primary view-ranks-btn" data-id="${id}">
                    <i class="bi bi-trophy me-1"></i> Ranks
                </button>
            </div>
        `;
    }
    
    return `
        <div class="col-md-6 col-lg-4">
            <div class="card paper-card">
                <div class="card-body">
                    <h5 class="card-title">${paper.title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${paper.year} - ${paper.subject}</h6>
                    <p class="card-text text-muted small">
                        ${isAvailable ? 
                            `Available until ${new Date(paper.closeTime).toLocaleString()}` : 
                            `Closed on ${new Date(paper.closeTime).toLocaleString()}`}
                    </p>
                    ${buttons}
                </div>
            </div>
        </div>
    `;
}

function isPaperAvailable(paper) {
    const now = Date.now();
    return now >= new Date(paper.openTime).getTime() && 
           now <= new Date(paper.closeTime).getTime();
}

function isPaperClosed(paper) {
    return Date.now() > new Date(paper.closeTime).getTime();
}

function addPaperCardEventListeners() {
    document.querySelectorAll('.download-paper-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-id');
            const medium = this.getAttribute('data-medium');
            downloadPaper(paperId, medium);
        });
    });
    
    document.querySelectorAll('.download-answers-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-id');
            downloadAnswers(paperId);
        });
    });
    
    document.querySelectorAll('.view-ranks-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            showSection('ranks');
            const rankFilter = document.getElementById('rankPaperFilter');
            if (rankFilter) rankFilter.value = this.getAttribute('data-id');
            loadRankings(this.getAttribute('data-id'));
        });
    });
}

async function checkPaperExists(paperId) {
  try {
    const snapshot = await database.ref(`papers/${paperId}`).once('value');
    return snapshot.exists();
  } catch (error) {
    console.error('Error checking paper:', error);
    return false;
  }
}

async function downloadPaper(paperId, medium) {
  try {
    console.groupCollapsed(`[Download] Starting download for ${paperId} (${medium})`);
    
    // Remove authentication check - allow downloads without login
    // const user = auth.currentUser || JSON.parse(localStorage.getItem('currentUser'));
    // if (!user) {
    //   console.log('User not authenticated');
    //   showToast('Please login to download papers', 'warning');
    //   return;
    // }

    // Verify paper exists in database
    const paperExists = await checkPaperExists(paperId);
    if (!paperExists) {
      console.log('Paper not found in database');
      showToast('Paper not found in system', 'warning');
      return;
    }

    // Get paper details
    const paperSnapshot = await database.ref(`papers/${paperId}`).once('value');
    const paper = paperSnapshot.val();
    console.log('Paper details:', paper);

    // Set loading state
    setButtonLoadingState(paperId, medium, true);

    // Define possible file locations
    const possibleFilePaths = [
      `papers/${paperId}/${medium}.pdf`,
      `papers/${paperId}/paper-${medium}.pdf`,
      `papers/${paperId}/${medium}/document.pdf`,
      `papers/${paper.year}/${paper.subject}/${medium}.pdf`,
      `${paperId}/${medium}.pdf`
    ];

    console.log('Trying these file paths:', possibleFilePaths);

    // Try each possible path
    let downloadUrl = null;
    for (const path of possibleFilePaths) {
      try {
        console.log(`Trying path: ${path}`);
        const fileRef = storage.ref(path);
        downloadUrl = await fileRef.getDownloadURL();
        console.log(`Found file at: ${path}`);
        break;
      } catch (error) {
        console.log(`Not found at ${path}:`, error.message);
      }
    }

    if (!downloadUrl) {
      console.log('File not found in any location');
      throw new Error('PAPER_NOT_FOUND');
    }

    // Trigger download
    triggerFileDownload(
      downloadUrl, 
      `${paper.title.replace(/\s+/g, '_')}-${medium}-${paper.year}.pdf`
    );

    showToast(`${medium} paper downloaded!`, 'success');

  } catch (error) {
    console.error('Download failed:', error);
    
    if (error.message === 'PAPER_NOT_FOUND') {
      showToast('This paper is not available for download', 'warning');
    } else if (error.code === 'storage/object-not-found') {
      showToast('Paper file not found on server', 'warning');
    } else if (error.code === 'storage/unauthorized') {
      showToast('You don\'t have download permission', 'warning');
    } else {
      showToast('Download failed: ' + error.message, 'danger');
    }
    
  } finally {
    setButtonLoadingState(paperId, medium, false);
    console.groupEnd();
  }
}

// Helper functions
function setButtonLoadingState(paperId, medium, isLoading) {
  const buttons = document.querySelectorAll(
    `.download-paper-btn[data-id="${paperId}"][data-medium="${medium}"]`
  );
  
  buttons.forEach(btn => {
    if (isLoading) {
      btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Downloading...`;
      btn.disabled = true;
    } else {
      btn.innerHTML = `<i class="bi bi-download me-1"></i> ${medium === 'sinhala' ? 'Sinhala' : 'English'}`;
      btn.disabled = false;
    }
  });
}

function triggerFileDownload(url, filename) {
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }, 100);
}

async function downloadAnswers(paperId) {
    try {
        // Remove authentication check
        // const user = JSON.parse(localStorage.getItem('currentUser'));
        // if (!user) {
        //     showToast('Please login to download answers', 'warning');
        //     return;
        // }

        if (!storage) {
            console.error("Firebase Storage not initialized");
            showToast("Download feature not available", "danger");
            return;
        }

        // Show loading state on the button
        const downloadBtns = document.querySelectorAll(`.download-answers-btn[data-id="${paperId}"]`);
        downloadBtns.forEach(btn => {
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Downloading...`;
            btn.disabled = true;
        });

        showToast("Preparing answers download...", "info");

        // 1. Get paper details
        const paperSnapshot = await database.ref(`papers/${paperId}`).once('value');
        const paper = paperSnapshot.val();
        
        if (!paper) {
            throw new Error("Paper not found in database");
        }

        // 2. Try multiple possible answer file paths
        const possiblePaths = [
            `papers/${paperId}/answers.pdf`,          // Option 1: papers/{paperId}/answers.pdf
            `papers/${paperId}/answer_sheet.pdf`,     // Option 2: papers/{paperId}/answer_sheet.pdf
            `answers/${paperId}.pdf`,                 // Option 3: answers/{paperId}.pdf
            `${paperId}_answers.pdf`                  // Option 4: {paperId}_answers.pdf
        ];

        let downloadUrl = null;
        let lastError = null;

        // Try each possible path until we find the file
        for (const filePath of possiblePaths) {
            try {
                console.log("Trying path:", filePath);
                const fileRef = storage.ref(filePath);
                downloadUrl = await fileRef.getDownloadURL();
                console.log("Found file at:", filePath);
                break; // Exit loop if successful
            } catch (error) {
                lastError = error;
                console.log("File not found at:", filePath);
                continue; // Try next path
            }
        }

        if (!downloadUrl) {
            throw lastError || new Error("Answer file not found in any expected location");
        }

        // 3. Create hidden link and trigger download
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `${paper.title.replace(/\s+/g, '_')}-answers-${paper.year}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast("Answers downloaded!", "success");

    } catch (error) {
        console.error("Download error:", error);
        
        // User-friendly error messages
        if (error.code === 'storage/object-not-found') {
            showToast("Answer sheet not found on server", "warning");
        } else {
            showToast("Failed to download answers", "danger");
        }
    } finally {
        // Restore button state
        const downloadBtns = document.querySelectorAll(`.download-answers-btn[data-id="${paperId}"]`);
        downloadBtns.forEach(btn => {
            btn.innerHTML = `<i class="bi bi-file-earmark-text me-1"></i> Answers`;
            btn.disabled = false;
        });
    }
}

// Rankings functions
function loadPapersForRankings() {
    const filter = document.getElementById('rankPaperFilter');
    if (!filter) return;
    
    filter.innerHTML = '<option value="">Select Paper</option>';
    
    database.ref('papers').once('value').then(snapshot => {
        const papers = snapshot.val() || {};
        const now = Date.now();
        
        Object.entries(papers).forEach(([id, paper]) => {
            if (now > new Date(paper.closeTime).getTime()) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${paper.title} (${paper.year})`;
                filter.appendChild(option);
            }
        });
        
        filter.addEventListener('change', function() {
            if (this.value) loadRankings(this.value);
        });
    }).catch(error => {
        console.error('Error loading papers:', error);
    });
}

async function loadRankings(paperId) {
    if (!paperId) {
        showPaperSelectionDialog();
        return;
    }
    
    // Show loading states
    document.getElementById('overallTopSchool').innerHTML = '<div class="spinner-border"></div>';
    document.getElementById('classTopSchool').innerHTML = '<div class="spinner-border"></div>';
    document.getElementById('overallRankings').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border"></div></td></tr>';
    document.getElementById('classRankings').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border"></div></td></tr>';
    
    const user = JSON.parse(localStorage.getItem('currentUser'));
    const userRankInfo = document.getElementById('userRankInfo');
    
    // Hide user rank info if not logged in
    if (userRankInfo) {
        userRankInfo.style.display = user ? 'block' : 'none';
    }
    
    try {
        const [paperSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}`).once('value')
        ]);

        const paper = paperSnapshot.val();
        const allSubmissions = submissionsSnapshot.val() || {};
        
        // Convert submissions to array and add rank
        let submissionsArray = Object.entries(allSubmissions).map(([nic, sub]) => ({ nic, ...sub }));
        submissionsArray.sort((a, b) => b.score - a.score);
        
        // Calculate ranks
        let rank = 1;
        submissionsArray.forEach((sub, i) => {
            if (i > 0 && sub.score < submissionsArray[i-1].score) rank = i + 1;
            sub.rank = rank;
        });
        
        // Get current class filter value
        const classFilter = document.getElementById('classFilter');
        let selectedClass = classFilter ? classFilter.value : null;
        
        // Set default class based on login status
        if (!selectedClass) {
            selectedClass = user ? user.class : 'Online';
            if (classFilter) {
                classFilter.value = selectedClass;
            }
        }
        
        // Display top 100 overall (unfiltered)
        const overallTop100 = submissionsArray.slice(0, 100);
        displayRankings(document.getElementById('overallRankings'), overallTop100, paper);
        
        // Filter by class if selected
        let classTop100 = [];
        if (selectedClass) {
            // Filter submissions by class and re-rank them
            const classSubmissions = submissionsArray.filter(sub => sub.class === selectedClass);
            
            // Re-rank within the class
            let classRank = 1;
            classSubmissions.forEach((sub, i) => {
                if (i > 0 && sub.score < classSubmissions[i-1].score) classRank = i + 1;
                sub.classRank = classRank;
            });
            
            classTop100 = classSubmissions.slice(0, 100);
        } else {
            // If no class selected, just show top 100 overall
            classTop100 = overallTop100;
        }
        
        displayRankings(document.getElementById('classRankings'), classTop100, paper);
        
        // Calculate and display top schools
        const { overallTopSchool, classTopSchool } = calculateTopSchools(submissionsArray, selectedClass);
        displayTopSchools(overallTopSchool, classTopSchool, selectedClass);
        
        // Show user rank if available and logged in
        if (user) {
            const userSubmission = submissionsArray.find(sub => sub.nic === user.nic);
            if (userSubmission) {
                showUserRank(userSubmission, paper, selectedClass ? classTop100 : overallTop100, selectedClass);
            }
        }
        
        // Update share button
        updateShareButton(paperId, selectedClass);
        
    } catch (error) {
        console.error('Error loading rankings:', error);
        document.getElementById('overallRankings').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading rankings</td></tr>';
        document.getElementById('classRankings').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading rankings</td></tr>';
    }
}

function showPaperSelectionDialog() {
    const dialogHTML = `
        <div class="modal fade" id="paperSelectionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Paper and Class</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="modalPaperFilter" class="form-label">Select Paper</label>
                            <select class="form-select" id="modalPaperFilter">
                                <option value="">Select Paper</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalClassFilter" class="form-label">Select Class</label>
                            <select class="form-select" id="modalClassFilter">
                                <option value="">All Island</option>
                                <option value="Nugegoda">Nugegoda</option>
                                <option value="Kandy">Kandy</option>
                                <option value="Kegalle">Kegalle</option>
                                <option value="Kurunegala">Kurunegala</option>
                                <option value="Gall">Gall</option>
                                <option value="Online" selected>Online</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="loadSelectedRankings">View Rankings</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = dialogHTML;
    document.body.appendChild(modalContainer);
    
    // Initialize modal
    const modal = new bootstrap.Modal(document.getElementById('paperSelectionModal'));
    modal.show();
    
    // Load papers into the modal dropdown
    loadPapersForModal();
    
    // Set up event listeners
    document.getElementById('loadSelectedRankings').addEventListener('click', function() {
        const paperId = document.getElementById('modalPaperFilter').value;
        const classValue = document.getElementById('modalClassFilter').value;
        
        if (!paperId) {
            showToast('Please select a paper', 'warning');
            return;
        }
        
        // Update main filters
        document.getElementById('rankPaperFilter').value = paperId;
        if (document.getElementById('classFilter')) {
            document.getElementById('classFilter').value = classValue;
        }
        
        // Load rankings
        loadRankings(paperId);
        
        // Close modal
        modal.hide();
        modalContainer.remove();
    });
    
    // Clean up when modal is closed
    document.getElementById('paperSelectionModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
    });
}

function loadPapersForModal() {
    const filter = document.getElementById('modalPaperFilter');
    if (!filter) return;
    
    database.ref('papers').once('value').then(snapshot => {
        const papers = snapshot.val() || {};
        const now = Date.now();
        
        Object.entries(papers).forEach(([id, paper]) => {
            if (now > new Date(paper.closeTime).getTime()) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${paper.title} (${paper.year})`;
                filter.appendChild(option);
            }
        });
    }).catch(error => {
        console.error('Error loading papers:', error);
    });
}

function updateShareButton(paperId, selectedClass) {
    const shareBtn = document.getElementById('shareRankingsBtn');
    if (!shareBtn) {
        // Create share button if it doesn't exist
        const shareBtnContainer = document.createElement('div');
        shareBtnContainer.className = 'text-end mb-3';
        shareBtnContainer.innerHTML = `
            <button class="btn btn-outline-primary" id="shareRankingsBtn">
                <i class="bi bi-share me-1"></i> Share Rankings
            </button>
        `;
        document.querySelector('#ranksSection .section-title').insertAdjacentElement('afterend', shareBtnContainer);
    }
    
    document.getElementById('shareRankingsBtn').addEventListener('click', function() {
        const shareUrl = `${window.location.origin}${window.location.pathname}#ranks?paper=${paperId}&class=${encodeURIComponent(selectedClass)}`;
        
        // Check if Web Share API is available
        if (navigator.share) {
            navigator.share({
                title: `Rankings for ${document.getElementById('rankPaperFilter').selectedOptions[0].text}`,
                text: 'Check out these rankings on eWings Papers',
                url: shareUrl
            }).catch(err => {
                console.log('Error sharing:', err);
                copyToClipboard(shareUrl);
            });
        } else {
            // Fallback to copy to clipboard
            copyToClipboard(shareUrl);
        }
    });
}

// Helper function to copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Link copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy link', 'danger');
    });
}


// Class filter change event
const classFilter = document.getElementById('classFilter');
if (classFilter) {
    classFilter.addEventListener('change', function() {
        const paperFilter = document.getElementById('rankPaperFilter');
        if (paperFilter && paperFilter.value) {
            loadRankings(paperFilter.value);
        }
    });
}


if (classFilter) {
  classFilter.addEventListener('change', function() {
    const selectedClass = this.value;
    const filtered = selectedClass 
      ? submissionsArray.filter(sub => sub.class === selectedClass)
      : submissionsArray;
    
    if (classRankings) {
      displayRankings(classRankings, filtered.slice(0, 100), paper, user);
    }
    
    // Update top schools when class filter changes
    const { overallTopSchool, classTopSchool } = calculateTopSchools(submissionsArray, selectedClass);
    displayTopSchools(overallTopSchool, classTopSchool, selectedClass);
    
    if (user) {
      const userSubmission = submissionsArray.find(sub => sub.nic === user.nic);
      if (userSubmission && userRankInfo) {
        showUserRank(userSubmission, paper, filtered, selectedClass);
      }
    }

    const paperFilter = document.getElementById('rankPaperFilter');
        if (paperFilter && paperFilter.value) {
            loadRankings(paperFilter.value);
        }
  });
}

function displayRankings(element, submissions, paper) {
    if (!element) return;
    
    if (submissions.length === 0) {
        element.innerHTML = '<tr><td colspan="4" class="text-center">No submissions found</td></tr>';
        return;
    }

    let html = '';
    submissions.forEach((sub, index) => {
        const percentage = paper.totalMarks > 0 
            ? ((sub.score / paper.totalMarks) * 100).toFixed(1)
            : '0';
        
        // Use classRank if available, otherwise use index + 1 for position
        const displayRank = sub.classRank || index + 1;
        
        html += `
            <tr>
                <td>${displayRank}</td>
                <td>${sub.name || 'N/A'}</td>
                <td>${sub.score}/${paper.totalMarks} (${percentage}%)</td>
                <td>${sub.school || 'N/A'}</td>
            </tr>
        `;
    });
    
    element.innerHTML = html;
}

function showUserRank(submission, paper, filteredSubmissions, selectedClass) {
    const percentage = ((submission.score / paper.totalMarks) * 100).toFixed(1);
    const userRankInfo = document.getElementById('userRankInfo');
    const userRankDetails = document.getElementById('userRankDetails');
    
    if (!userRankInfo || !userRankDetails) return;
    
    // Find the user's rank in the filtered submissions
    const userRankInFiltered = filteredSubmissions.findIndex(sub => sub.nic === submission.nic) + 1;
    
    userRankDetails.innerHTML = `
        <p><strong>Paper:</strong> ${paper.title} (${paper.year})</p>
        <p><strong>Score:</strong> ${submission.score}/${paper.totalMarks} (${percentage}%)</p>
        <p><strong>Overall Rank:</strong> ${submission.rank}</p>
        ${selectedClass ? `<p><strong>${selectedClass} Class Rank:</strong> ${submission.classRank || userRankInFiltered}</p>` : ''}
    `;
    userRankInfo.style.display = 'block';
}

// Stats section functions 
async function loadUserStats() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) {
        showToast('Please login to view stats', 'warning');
        return;
    }

    try {
        // Show loading state
        document.getElementById('mySubmissionsTable').innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border"></div>
                </td>
            </tr>
        `;

        // Get all papers and submissions
        const [papersSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref('papers').once('value'),
            database.ref('submissions').once('value')
        ]);

        const papers = papersSnapshot.val() || {};
        const allSubmissions = submissionsSnapshot.val() || {};
        let userSubmissions = [];

        // Current timestamp for comparison
        const now = Date.now();

        // Process all submissions to find the user's submissions for closed papers only
        Object.entries(allSubmissions).forEach(([paperId, paperSubmissions]) => {
            const paper = papers[paperId];
            if (paper && paperSubmissions) {
                // Check if paper is closed
                const closeTime = new Date(paper.closeTime).getTime();
                if (now > closeTime) {
                    const submission = paperSubmissions[user.nic];
                    if (submission) {
                        // Calculate rank among all submissions for this paper
                        const allSubs = Object.values(paperSubmissions);
                        allSubs.sort((a, b) => b.score - a.score);
                        
                        let rank = 1;
                        allSubs.forEach((sub, index) => {
                            if (index > 0 && sub.score < allSubs[index-1].score) {
                                rank = index + 1;
                            }
                            if (sub.nic === user.nic) {
                                submission.rank = rank;
                            }
                        });

                        // Calculate class rank if class is available
                        if (user.class) {
                            const classSubs = allSubs.filter(sub => sub.class === user.class);
                            let classRank = 1;
                            classSubs.forEach((sub, index) => {
                                if (index > 0 && sub.score < classSubs[index-1].score) {
                                    classRank = index + 1;
                                }
                                if (sub.nic === user.nic) {
                                    submission.classRank = classRank;
                                }
                            });
                        }

                        userSubmissions.push({
                            paperId,
                            paperTitle: paper.title,
                            paperYear: paper.year,
                            paperSubject: paper.subject,
                            score: submission.score,
                            totalMarks: submission.totalPossible || paper.totalMarks || 100,
                            rank: submission.rank || 'N/A',
                            classRank: submission.classRank || 'N/A',
                            timestamp: submission.timestamp || Date.now(),
                            answers: submission.answers || {},
                            paperCloseTime: closeTime,
                            questions: paper.questions || {}
                        });
                    }
                }
            }
        });

        // Sort by timestamp (newest first)
        userSubmissions.sort((a, b) => b.timestamp - a.timestamp);

        // Update stats cards (only count closed papers)
        updateStatsCards(userSubmissions);

        // Initialize performance chart (only closed papers)
        initializePerformanceChart(userSubmissions);

        // Display submissions table (only closed papers)
        displaySubmissionsTable(userSubmissions);

        // Store submissions for filtering
        window.userSubmissions = userSubmissions;

    } catch (error) {
        console.error('Error loading user stats:', error);
        document.getElementById('mySubmissionsTable').innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-danger">
                    Error loading submissions. Please try again.
                </td>
            </tr>
        `;
        showToast('Failed to load performance data', 'danger');
    }
}

// Update stats cards
function updateStatsCards(submissions) {
    if (submissions.length === 0) {
        document.getElementById('totalPapersTakenStat').textContent = '0';
        document.getElementById('averageScoreStat').textContent = '0%';
        document.getElementById('bestRankStat').textContent = 'N/A';
        document.getElementById('improvementStat').textContent = '0%';
        return;
    }

    // Total papers taken
    document.getElementById('totalPapersTakenStat').textContent = submissions.length;

    // Average score
    const totalScore = submissions.reduce((sum, sub) => sum + sub.score, 0);
    const totalPossible = submissions.reduce((sum, sub) => sum + sub.totalMarks, 0);
    const averageScore = totalPossible > 0 ? (totalScore / totalPossible * 100).toFixed(1) : 0;
    document.getElementById('averageScoreStat').textContent = `${averageScore}%`;

    // Best rank
    const validRanks = submissions.filter(sub => typeof sub.rank === 'number');
    const bestRank = validRanks.length > 0 ? Math.min(...validRanks.map(sub => sub.rank)) : 'N/A';
    document.getElementById('bestRankStat').textContent = bestRank;

    // Improvement (compare last two papers)
    if (submissions.length >= 2) {
        const lastPaper = submissions[0]; // Most recent
        const prevPaper = submissions[1]; // Previous
        
        const lastScore = lastPaper.score / lastPaper.totalMarks;
        const prevScore = prevPaper.score / prevPaper.totalMarks;
        
        const improvement = prevScore > 0 ? ((lastScore - prevScore) / prevScore * 100).toFixed(1) : 'N/A';
        document.getElementById('improvementStat').textContent = 
            typeof improvement === 'string' ? improvement : `${improvement}%`;
    } else {
        document.getElementById('improvementStat').textContent = 'N/A';
    }
}

function setupSubmissionFilters() {
    const filterItems = document.querySelectorAll('[data-filter]');
    
    filterItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            filterItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Get filter type
            const filterType = this.getAttribute('data-filter');
            
            // Get the submissions data
            const statsSection = document.getElementById('statsSection');
            let submissions = JSON.parse(statsSection.dataset.submissions || '[]');
            
            // Apply filter
            let filteredSubmissions = [...submissions];
            
            switch(filterType) {
                case 'recent':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    filteredSubmissions = submissions.filter(sub => 
                        new Date(sub.timestamp) >= thirtyDaysAgo
                    );
                    break;
                    
                case 'top':
                    filteredSubmissions = [...submissions].sort((a, b) => 
                        (b.score / b.totalMarks) - (a.score / a.totalMarks)
                    ).slice(0, 5);
                    break;
                    
                case 'subject':
                    // Group by subject and get top submission for each
                    const subjects = {};
                    submissions.forEach(sub => {
                        if (!subjects[sub.paperSubject]) {
                            subjects[sub.paperSubject] = sub;
                        } else {
                            const currentScore = subjects[sub.paperSubject].score / subjects[sub.paperSubject].totalMarks;
                            const newScore = sub.score / sub.totalMarks;
                            if (newScore > currentScore) {
                                subjects[sub.paperSubject] = sub;
                            }
                        }
                    });
                    filteredSubmissions = Object.values(subjects);
                    break;
                    
                // 'all' filter - no changes needed
            }
            
            // Update the table
            updateStatsUI(filteredSubmissions);
        });
    });
}

function updateStatsUI(submissions) {
    const tableBody = document.getElementById('mySubmissions');
    if (!tableBody) return;

    const showingCount = document.getElementById('showingCount');
    const totalCount = document.getElementById('totalCount');
    const statsSection = document.getElementById('statsSection');
    const allSubmissions = JSON.parse(statsSection.dataset.submissions || '[]');

    showingCount.textContent = submissions.length;
    totalCount.textContent = allSubmissions.length;

    if (submissions.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">No submissions found</td></tr>`;
        return;
    }

    tableBody.innerHTML = submissions.map(sub => {
    const percentage = ((sub.score / sub.totalMarks) * 100).toFixed(1);
    const date = sub.timestamp ? new Date(sub.timestamp).toLocaleDateString() : 'N/A';
    return `
        <tr>
            <td>${sub.paperTitle}</td>
            <td>${sub.paperYear}</td>
            <td>${sub.score}/${sub.totalMarks} (${percentage}%)</td>
            <td>${date}</td>
            <td>${sub.classRank || 'N/A'}</td>
            <td>${sub.rank || 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary view-submission-btn" 
                        data-paperid="${sub.paperId}">
                    <i class="bi bi-eye"></i> View
                </button>
            </td>
        </tr>
    `;
    }).join('');

    // Initialize performance chart
    initializePerformanceChart(allSubmissions);
}

// event listener for view buttons
document.addEventListener('click', function(e) {
    const viewBtn = e.target.closest('.view-submission-btn');
    if (viewBtn) {
        try {
            const submissionData = viewBtn.getAttribute('data-submission');
            if (submissionData) {
                const submission = JSON.parse(submissionData);
                showSubmissionDetails(submission);
            }
        } catch (error) {
            console.error('Error parsing submission data:', error);
            showToast('Failed to load submission details', 'danger');
        }
    }
});

// Initialize the modal on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('submissionDetailsModal')) {
        window.submissionModal = new bootstrap.Modal(
            document.getElementById('submissionDetailsModal')
        );
    }
});

document.addEventListener('click', function(e) {
    const viewBtn = e.target.closest('.view-submission-btn');
    if (viewBtn) {
        const paperId = viewBtn.getAttribute('data-paperid');
        const submissions = window.userSubmissions || [];
        const submission = submissions.find(sub => sub.paperId === paperId);
        
        if (submission) {
            // Make sure we're passing the full submission object
            showSubmissionDetails(submission);
            
            // Update the download button to use this submission
            document.getElementById('downloadSubmissionBtn').onclick = () => {
                generateAndDownloadReport(submission, {
                    title: submission.paperTitle,
                    year: submission.paperYear,
                    subject: submission.paperSubject,
                    totalMarks: submission.totalMarks,
                    closeTime: submission.paperCloseTime,
                    questions: submission.questions || {}
                });
            };
        }
    }
});

async function initializePerformanceChart(submissions) {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;

    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    // Sort submissions chronologically
    const sortedSubmissions = [...submissions].sort((a, b) => a.timestamp - b.timestamp);
    
    // Get class averages for each paper
    const classAverages = await Promise.all(
        sortedSubmissions.map(async sub => {
            return await calculateClassAverage(sub.paperId);
        })
    );

    ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedSubmissions.map(sub => {
                const date = new Date(sub.timestamp);
                return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
            }),
            datasets: [
                {
                    label: 'Your Score (%)',
                    data: sortedSubmissions.map(sub => 
                        Math.round((sub.score / sub.totalMarks) * 100)
                    ),
                    borderColor: 'rgba(78, 115, 223, 1)',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Class Average (%)',
                    data: classAverages,
                    borderColor: 'rgba(28, 200, 138, 1)',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.3,
                    borderDash: [5, 5],
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Submission Date'
                    }
                }
            }
        }
    });
}

async function calculateClassAverage(paperId) {
    try {
        // Get all submissions for this paper
        const snapshot = await database.ref(`submissions/${paperId}`).once('value');
        const submissions = snapshot.val() || {};
        
        // Convert to array
        const submissionsArray = Object.values(submissions);
        
        if (submissionsArray.length === 0) return 0;
        
        // Calculate total percentage
        const total = submissionsArray.reduce((sum, sub) => {
            const totalPossible = sub.totalPossible || 100; // Default to 100 if not specified
            return sum + (sub.score / totalPossible) * 100;
        }, 0);
        
        return Math.round(total / submissionsArray.length);
    } catch (error) {
        console.error('Error calculating class average:', error);
        return 0;
    }
}

function displaySubmissionsTable(submissions, filterType = 'all') {
    const tableBody = document.getElementById('mySubmissionsTable');
    if (!tableBody) return;

    // Apply filter
    let filteredSubmissions = [...submissions];
    
    switch(filterType) {
        case 'recent':
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            filteredSubmissions = submissions.filter(sub => 
                new Date(sub.timestamp) >= thirtyDaysAgo
            );
            break;
            
        case 'top':
            filteredSubmissions = [...submissions].sort((a, b) => 
                (b.score / b.totalMarks) - (a.score / a.totalMarks)
            ).slice(0, 5);
            break;
            
        case 'subject':
            // Group by subject and get top submission for each
            const subjects = {};
            submissions.forEach(sub => {
                if (!subjects[sub.paperSubject]) {
                    subjects[sub.paperSubject] = sub;
                } else {
                    const currentScore = subjects[sub.paperSubject].score / subjects[sub.paperSubject].totalMarks;
                    const newScore = sub.score / sub.totalMarks;
                    if (newScore > currentScore) {
                        subjects[sub.paperSubject] = sub;
                    }
                }
            });
            filteredSubmissions = Object.values(subjects);
            break;
            
        // 'all' filter - no changes needed
    }

    if (filteredSubmissions.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    No completed papers found
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = filteredSubmissions.map(sub => {
        const percentage = ((sub.score / sub.totalMarks) * 100).toFixed(1);
        const date = new Date(sub.timestamp).toLocaleDateString();
        
        return `
            <tr>
                <td>${sub.paperTitle} (${sub.paperYear})</td>
                <td>${date}</td>
                <td>${sub.score}/${sub.totalMarks} (${percentage}%)</td>
                <td>${sub.classRank}</td>
                <td>${sub.rank}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission-btn" 
                            data-paperid="${sub.paperId}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    // Add event listeners to view buttons
    document.querySelectorAll('.view-submission-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-paperid');
            const submission = submissions.find(sub => sub.paperId === paperId);
            if (submission) {
                showSubmissionDetails(submission);
            }
        });
    });
}

function setupSubmissionViewButtons() {
    document.querySelectorAll('.view-submission-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const paperId = this.getAttribute('data-paperid');
        const user = JSON.parse(localStorage.getItem('currentUser'));
        
            try {
                const snapshot = await database.ref(`submissions/${paperId}/${user.nic}`).once('value');
                const submission = snapshot.val();
                submission.paperId = paperId;
                submission.nic = user.nic;
                await showSubmissionDetails(submission);
            } catch (error) {
                console.error('Error loading submission:', error);
                showToast('Failed to load submission details', 'danger');
            }
        });
    });
}

function showStatsError(message) {
    const statsSection = document.getElementById('statsSection');
    if (!statsSection) return;
    
    statsSection.innerHTML = `
        <div class="alert alert-danger">
            <h4><i class="bi bi-exclamation-triangle me-2"></i> Error Loading Stats</h4>
            <p>${message}</p>
            <button onclick="loadUserStats()" class="btn btn-sm btn-primary mt-2">
                <i class="bi bi-arrow-repeat me-1"></i> Try Again
            </button>
        </div>
    `;
}

// Show submission details modal
async function showSubmissionDetails(submission) {
    try {
        // Show loading state
        const modalContent = document.getElementById('submissionDetailsContent');
        modalContent.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Loading detailed results...</p>
            </div>
        `;

        // Initialize modal
        const modal = new bootstrap.Modal(document.getElementById('submissionDetailsModal'));
        modal.show();

        // Get all required data in parallel
        const [paperSnapshot, allSubmissionsSnapshot, userData, classAverage] = await Promise.all([
            database.ref(`papers/${submission.paperId}`).once('value'),
            database.ref(`submissions/${submission.paperId}`).once('value'),
            database.ref(`users/${auth.currentUser.uid}`).once('value'),
            calculateClassAverage(submission.paperId)
        ]);

        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');
        
        const allSubmissions = allSubmissionsSnapshot.val() || {};
        const user = userData.val() || JSON.parse(localStorage.getItem('currentUser')) || {};

        // Convert to array and calculate ranks
        let submissionsArray = Object.entries(allSubmissions).map(([nic, sub]) => ({ nic, ...sub }));
        submissionsArray.sort((a, b) => b.score - a.score);
        
        // Calculate ranks
        let rank = 1;
        submissionsArray.forEach((sub, i) => {
            if (i > 0 && sub.score < submissionsArray[i-1].score) rank = i + 1;
            sub.rank = rank;
        });

        // Calculate class rank if user has a class
        let classRank = 'N/A';
        if (user.class) {
            const classSubmissions = submissionsArray.filter(sub => sub.class === user.class);
            let cr = 1;
            classSubmissions.forEach((sub, i) => {
                if (i > 0 && sub.score < classSubmissions[i-1].score) cr = i + 1;
                sub.classRank = cr;
                
                if (sub.nic === user.nic) {
                    classRank = cr;
                }
            });
        }

        // Build modal content with accurate comparisons
        const percentage = Math.round((submission.score / (submission.totalPossible || paper.totalMarks || 100)) * 100);
        const date = new Date(submission.timestamp).toLocaleString();
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>${submission.name || user.name || 'Your Submission'}</h5>
                    <p class="mb-1"><strong>Submitted:</strong> ${date}</p>
                    <p class="mb-1"><strong>Class Rank:</strong> ${classRank}</p>
                    <p><strong>Overall Rank:</strong> ${submission.rank}</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="display-4">${percentage}%</div>
                    <p class="lead">${submission.score}/${submission.totalPossible || paper.totalMarks || 100} marks</p>
                    <p class="text-muted">Class Average: ${classAverage}%</p>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i> Performance Comparison
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="submissionComparisonChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-list-check me-2"></i> Question Breakdown
                </div>
                <div class="card-body">
        `;

        // Add question details if available
        if (paper.questions && submission.answers) {
            html += `
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Your Answer</th>
                                <th>Correct Answer</th>
                                <th>Marks</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(paper.questions).forEach(([qNum, question]) => {
                const studentAnswer = submission.answers[qNum] || '-';
                const isCorrect = studentAnswer === question.answer;
                const marksEarned = isCorrect ? question.marks : 0;
                
                html += `
                    <tr>
                        <td>${question.questionText || 'Question ' + qNum}</td>
                        <td class="${isCorrect ? 'text-success' : 'text-danger'}">${studentAnswer}</td>
                        <td>${question.answer}</td>
                        <td>${marksEarned}/${question.marks}</td>
                        <td class="${isCorrect ? 'text-success' : 'text-danger'}">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            html += `
                <div class="text-center py-4">
                    No detailed question data available
                </div>
            `;
        }

        html += `
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                For detailed feedback, please attend the paper class discussion.
            </div>
        `;

        // Set modal content
        modalContent.innerHTML = html;

        // Initialize comparison chart
        initializeSubmissionComparisonChart(
            percentage, 
            classAverage,
            submission.paperId
        );

        // Proper modal cleanup
        const modalElement = document.getElementById('submissionDetailsModal');
        const cleanUpModal = () => {
            modalElement.removeEventListener('hidden.bs.modal', cleanUpModal);
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        };
        modalElement.addEventListener('hidden.bs.modal', cleanUpModal);

        // Set up download button with proper event handling
        const downloadBtn = document.getElementById('downloadSubmissionBtn');
        downloadBtn.onclick = null; // Clear previous handlers
        downloadBtn.onclick = async () => {
            await generateAndDownloadReport(submission, paper, user);
        };

    } catch (error) {
        console.error('Error showing submission details:', error);
        document.getElementById('submissionDetailsContent').innerHTML = `
            <div class="alert alert-danger">
                <h4><i class="bi bi-exclamation-triangle me-2"></i> Error</h4>
                <p>${error.message || 'Failed to load submission details'}</p>
                <button class="btn btn-sm btn-primary mt-2" onclick="window.location.reload()">
                    <i class="bi bi-arrow-repeat me-1"></i> Refresh
                </button>
            </div>
        `;
    }
}

async function initializeSubmissionComparisonChart(userScore, classAverage, paperId) {
    const ctx = document.getElementById('submissionComparisonChart');
    if (!ctx) return;
    
    // Get top score for this paper
    const topScore = await calculateTopScore(paperId);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Your Score', 'Class Average', 'Top Score'],
            datasets: [{
                label: 'Score Comparison',
                data: [userScore, classAverage, topScore],
                backgroundColor: [
                    'rgba(78, 115, 223, 0.7)',
                    'rgba(28, 200, 138, 0.7)',
                    'rgba(246, 194, 62, 0.7)'
                ],
                borderColor: [
                    'rgba(78, 115, 223, 1)',
                    'rgba(28, 200, 138, 1)',
                    'rgba(246, 194, 62, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                }
            }
        }
    });
}

async function calculateTopScore(paperId) {
    try {
        const snapshot = await database.ref(`submissions/${paperId}`).once('value');
        const submissions = snapshot.val() || {};
        
        if (Object.keys(submissions).length === 0) return 0;
        
        // Find the highest score
        let topScore = 0;
        Object.values(submissions).forEach(sub => {
            const totalPossible = sub.totalPossible || 100;
            const percentage = (sub.score / totalPossible) * 100;
            if (percentage > topScore) topScore = percentage;
        });
        
        return Math.round(topScore);
    } catch (error) {
        console.error('Error calculating top score:', error);
        return 0;
    }
}

function displayAnswersAnalysis(answers) {
    try {
        console.log('Displaying answers analysis:', answers);

        const correctList = document.getElementById('correctAnswersList');
        const incorrectList = document.getElementById('incorrectAnswersList');
        
        // Clear previous content
        correctList.innerHTML = '';
        incorrectList.innerHTML = '';
        
        // Validate answers data
        if (!answers || typeof answers !== 'object') {
            console.warn('No valid answers data provided');
            correctList.innerHTML = '<div class="text-muted">No answer data available</div>';
            incorrectList.innerHTML = '<div class="text-muted">No answer data available</div>';
            document.getElementById('answersSummary').textContent = '0/0 questions';
            document.getElementById('correctAnswersHeader').textContent = 'Correct Answers (0)';
            document.getElementById('incorrectAnswersHeader').textContent = 'Incorrect Answers (0)';
            return;
        }
        
        // Get all question numbers
        const questionNumbers = Object.keys(answers).filter(key => !isNaN(key));
        const totalQuestions = questionNumbers.length;
        let correctCount = 0;
        let totalMarks = 0;
        let obtainedMarks = 0;
        
        questionNumbers.forEach(questionId => {
            const answer = answers[questionId];
            
            // Skip if answer is null or undefined
            if (answer == null) return;
            
            // Handle both object and simple formats
            let isCorrect, marksAwarded, maxMarks, feedback, correctAnswer, yourAnswer;
            
            if (typeof answer === 'object') {
                isCorrect = answer.isCorrect || false;
                marksAwarded = typeof answer.marksAwarded === 'number' ? answer.marksAwarded : 0;
                maxMarks = typeof answer.maxMarks === 'number' ? answer.maxMarks : 1;
                feedback = answer.feedback || '';
                correctAnswer = answer.correctAnswer || '';
                yourAnswer = answer.yourAnswer || '';
            } else {
                // Simple format - assume it's the student's answer
                isCorrect = answer === correctAnswer; // Compare with correct answer if available
                marksAwarded = isCorrect ? maxMarks : 0;
                maxMarks = 1; // Default to 1 mark if not specified
                feedback = '';
                correctAnswer = ''; // Unknown in this case
                yourAnswer = answer;
            }
            
            // Update counts
            if (isCorrect) correctCount++;
            totalMarks += maxMarks;
            obtainedMarks += marksAwarded;
            
            const answerItem = document.createElement('div');
            answerItem.className = 'answer-item';
            answerItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Question ${questionId}:</strong>
                        <span class="ms-2 badge ${isCorrect ? 'bg-success' : 'bg-danger'}">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </span>
                    </div>
                    <span>${marksAwarded}/${maxMarks} marks</span>
                </div>
                <div class="answer-details">
                    ${feedback ? `<div class="mt-2"><strong>Feedback:</strong> ${feedback}</div>` : ''}
                    ${correctAnswer ? `<div class="mt-1"><strong>Correct Answer:</strong> ${correctAnswer}</div>` : ''}
                    ${yourAnswer ? `<div class="mt-1"><strong>Your Answer:</strong> ${yourAnswer}</div>` : ''}
                </div>
            `;
            
            if (isCorrect) {
                correctList.appendChild(answerItem);
            } else {
                incorrectList.appendChild(answerItem);
            }
        });
        
        const incorrectCount = totalQuestions - correctCount;
        
        // Update headers with counts
        document.getElementById('answersSummary').textContent = 
            `${correctCount}/${totalQuestions} questions (${obtainedMarks}/${totalMarks} marks)`;
        document.getElementById('correctAnswersHeader').textContent = 
            `Correct Answers (${correctCount})`;
        document.getElementById('incorrectAnswersHeader').textContent = 
            `Incorrect Answers (${incorrectCount})`;
        
        // Handle empty states
        if (correctCount === 0) {
            correctList.innerHTML = '<div class="text-muted">No correct answers</div>';
        }
        if (incorrectCount === 0) {
            incorrectList.innerHTML = '<div class="text-muted">No incorrect answers</div>';
        }

    } catch (error) {
        console.error('Error in displayAnswersAnalysis:', error);
        const correctList = document.getElementById('correctAnswersList');
        const incorrectList = document.getElementById('incorrectAnswersList');
        correctList.innerHTML = '<div class="text-danger">Error loading answers</div>';
        incorrectList.innerHTML = '<div class="text-danger">Error loading answers</div>';
    }
}

function setupAnswerItemInteractivity() {
    // Toggle answer details on click
    document.querySelectorAll('.answer-item').forEach(item => {
        item.addEventListener('click', function() {
            this.classList.toggle('expanded');
        });
    });
    
    // Expand all button
    document.getElementById('expandAllAnswers').addEventListener('click', function() {
        document.querySelectorAll('.answer-item').forEach(item => {
            item.classList.add('expanded');
        });
    });
    
    // Collapse all button
    document.getElementById('collapseAllAnswers').addEventListener('click', function() {
        document.querySelectorAll('.answer-item').forEach(item => {
            item.classList.remove('expanded');
        });
    });
}

function initializeSubmissionChart(submission) {
    const ctx = document.getElementById('submissionChart');
    if (!ctx) return;
    
    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Calculate scores
    const yourScore = Math.round((submission.score / submission.totalMarks) * 100);
    const classAverage = Math.min(100, Math.max(50, yourScore - 10 + Math.floor(Math.random() * 20)));
    const topScore = Math.min(100, yourScore + 10 + Math.floor(Math.random() * 10));
    
    // Update progress bars
    document.getElementById('yourScoreBar').style.width = `${yourScore}%`;
    document.getElementById('classAvgBar').style.width = `${classAverage}%`;
    document.getElementById('topScoreBar').style.width = `${topScore}%`;
    
    // Update percentage labels
    document.querySelector('.progress').previousElementSibling.children[0].textContent = `${yourScore}%`;
    document.querySelector('.progress').previousElementSibling.children[1].textContent = `${classAverage}%`;
    document.querySelector('.progress').previousElementSibling.children[2].textContent = `${topScore}%`;
    
    // Create chart
    ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Knowledge', 'Application', 'Analysis', 'Evaluation'],
            datasets: [
                {
                    label: 'Your Score',
                    data: [
                        Math.floor(Math.random() * 20) + 60,
                        Math.floor(Math.random() * 20) + 60,
                        Math.floor(Math.random() * 20) + 60,
                        Math.floor(Math.random() * 20) + 60
                    ],
                    backgroundColor: 'rgba(78, 115, 223, 0.7)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Class Average',
                    data: [
                        Math.floor(Math.random() * 20) + 50,
                        Math.floor(Math.random() * 20) + 50,
                        Math.floor(Math.random() * 20) + 50,
                        Math.floor(Math.random() * 20) + 50
                    ],
                    backgroundColor: 'rgba(28, 200, 138, 0.7)',
                    borderColor: 'rgba(28, 200, 138, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Top Score',
                    data: [
                        Math.floor(Math.random() * 10) + 85,
                        Math.floor(Math.random() * 10) + 85,
                        Math.floor(Math.random() * 10) + 85,
                        Math.floor(Math.random() * 10) + 85
                    ],
                    backgroundColor: 'rgba(246, 194, 62, 0.7)',
                    borderColor: 'rgba(246, 194, 62, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Skill Category'
                    }
                }
            }
        }
    });
}

// Add this near the top of your script
const rankCache = {};

async function getRanksForPaper(paperId, nic) {
    const cacheKey = `${paperId}_${nic}`;
    
    if (rankCache[cacheKey]) {
        return rankCache[cacheKey];
    }
    
    const submissionsSnapshot = await database.ref(`submissions/${paperId}`).once('value');
    const allSubmissions = submissionsSnapshot.val() || {};
    let submissionsArray = Object.entries(allSubmissions).map(([nic, sub]) => ({ nic, ...sub }));
    
    // Sort and calculate ranks
    submissionsArray.sort((a, b) => b.score - a.score);
    
    let rank = 1;
    submissionsArray.forEach((sub, i) => {
        if (i > 0 && sub.score < submissionsArray[i-1].score) rank = i + 1;
        sub.rank = rank;
    });
    
    // Calculate class rank if applicable
    let classRank = null;
    const user = JSON.parse(localStorage.getItem('currentUser')) || {};
    if (user.class) {
        const classSubmissions = submissionsArray.filter(sub => sub.class === user.class);
        let cr = 1;
        classSubmissions.forEach((sub, i) => {
            if (i > 0 && sub.score < classSubmissions[i-1].score) cr = i + 1;
            sub.classRank = cr;
            
            if (sub.nic === nic) {
                classRank = cr;
            }
        });
    }
    
    const userSubmission = submissionsArray.find(sub => sub.nic === nic);
    const result = {
        overallRank: userSubmission?.rank || null,
        classRank: classRank
    };
    
    rankCache[cacheKey] = result;
    return result;
}

// Generate and download report
async function generateAndDownloadReport(submission, paper) {
    const downloadBtn = document.getElementById('downloadSubmissionBtn');
    const originalText = downloadBtn.innerHTML;
    
    const ranks = await getRanksForPaper(submission.paperId, submission.nic);
    submission.rank = ranks.overallRank;
    submission.classRank = ranks.classRank;

    try {
        // Show loading state
        downloadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
        downloadBtn.disabled = true;

        // Get user data
        const user = JSON.parse(localStorage.getItem('currentUser')) || {};

        // Get fresh rank data (same as in showSubmissionDetails)
        const submissionsSnapshot = await database.ref(`submissions/${submission.paperId}`).once('value');
        const allSubmissions = submissionsSnapshot.val() || {};
        
        // Convert to array and calculate ranks
        let submissionsArray = Object.entries(allSubmissions).map(([nic, sub]) => ({ nic, ...sub }));
        submissionsArray.sort((a, b) => b.score - a.score);
        
        // Calculate overall ranks
        let rank = 1;
        submissionsArray.forEach((sub, i) => {
            if (i > 0 && sub.score < submissionsArray[i-1].score) rank = i + 1;
            sub.rank = rank;
            
            if (sub.nic === submission.nic) {
                submission.rank = rank;
            }
        });

        // Calculate class ranks if user has a class
        if (user.class) {
            const classSubmissions = submissionsArray.filter(sub => sub.class === user.class);
            let classRank = 1;
            classSubmissions.forEach((sub, i) => {
                if (i > 0 && sub.score < classSubmissions[i-1].score) classRank = i + 1;
                sub.classRank = classRank;
                
                if (sub.nic === submission.nic) {
                    submission.classRank = classRank;
                }
            });
        }

        // Create report with updated rank data
        const reportDiv = document.createElement('div');
        reportDiv.style.width = '210mm';
        reportDiv.style.padding = '20px';
        reportDiv.style.fontFamily = "'Inter', sans-serif";
        
        // Report HTML with embedded CSS
        reportDiv.innerHTML = `
            <style>
                .report-container {
                    width: 100%;
                    max-width: 210mm;
                    margin: 0 auto;
                    font-family: 'Inter', sans-serif;
                    color: #333;
                    line-height: 1.5;
                }
                .report-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid #2c3e50;
                }
                .logo-container {
                    display: flex;
                    align-items: center;
                }
                .logo-text {
                    font-size: 18px;
                    font-weight: 600;
                    margin-left: 10px;
                    color: #2c3e50;
                }
                .report-title {
                    color: #2c3e50;
                    margin: 0;
                    font-size: 24px;
                }
                .report-meta {
                    text-align: right;
                    font-size: 12px;
                    color: #666;
                }
                .report-section {
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                .section-title {
                    color: #2c3e50;
                    font-size: 18px;
                    margin-bottom: 15px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #eee;
                }
                .summary-cards {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                    margin-bottom: 20px;
                }
                .summary-card {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .summary-value {
                    font-size: 24px;
                    font-weight: 600;
                    margin-bottom: 5px;
                    color: #2c3e50;
                }
                .summary-label {
                    font-size: 12px;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                }
                .report-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                    font-size: 14px;
                }
                .report-table th, .report-table td {
                    padding: 10px;
                    text-align: left;
                    border: 1px solid #ddd;
                }
                .report-table th {
                    background-color: #2c3e50;
                    color: white;
                }
                .report-table tr:nth-child(even) {
                    background-color: #f8f9fa;
                }
                .correct-answer {
                    color: #28a745;
                    font-weight: 600;
                }
                .incorrect-answer {
                    color: #dc3545;
                    font-weight: 600;
                }
                .chart-container {
                    height: 300px;
                    margin: 20px 0;
                }
                .report-footer {
                    margin-top: 30px;
                    padding-top: 15px;
                    border-top: 1px solid #eee;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
                @media print {
                    body {
                        margin: 0;
                        padding: 0;
                    }
                    .report-container {
                        padding: 0;
                    }
                }
            </style>

            <div class="report-container">
                <div class="report-header">
                    <div class="logo-container">
                        <div class="logo-text">eWings Papers</div>
                    </div>
                    <div class="report-meta">
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                        <p><strong>Student ID:</strong> ${user.studentId || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="report-section">
                    <h2 class="section-title">Student Information</h2>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-value">${user.name || 'N/A'}</div>
                            <div class="summary-label">Student Name</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${user.class || 'N/A'}</div>
                            <div class="summary-label">Class</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${user.school || 'N/A'}</div>
                            <div class="summary-label">School</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${user.registeredYear || 'N/A'}</div>
                            <div class="summary-label">Year</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h2 class="section-title">Paper Summary</h2>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-value">${paper.title}</div>
                            <div class="summary-label">Paper Title</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${paper.year}</div>
                            <div class="summary-label">Year</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${paper.subject}</div>
                            <div class="summary-label">Subject</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${new Date(paper.closeTime).toLocaleDateString()}</div>
                            <div class="summary-label">Date Taken</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h2 class="section-title">Performance Summary</h2>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-value">${submission.score}/${submission.totalMarks}</div>
                            <div class="summary-label">Raw Score</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${Math.round((submission.score / submission.totalMarks) * 100)}%</div>
                            <div class="summary-label">Percentage</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h2 class="section-title">Performance Analysis</h2>
                    <div class="chart-container">
                        <canvas id="report-chart" width="800" height="300"></canvas>
                    </div>
                </div>
                
                <div class="report-section">
                    <h2 class="section-title">Question Breakdown</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Your Answer</th>
                                <th>Correct Answer</th>
                                <th>Marks</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="report-questions">
                            ${paper.questions && submission.answers ? 
                                Object.entries(paper.questions).map(([qNum, question]) => {
                                    const studentAnswer = submission.answers[qNum] || '-';
                                    const isCorrect = studentAnswer === question.answer;
                                    const marksEarned = isCorrect ? question.marks : 0;
                                    return `
                                        <tr>
                                            <td>${question.questionText || 'Question ' + qNum}</td>
                                            <td class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">${studentAnswer}</td>
                                            <td>${question.answer}</td>
                                            <td>${marksEarned}/${question.marks}</td>
                                            <td class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">
                                                ${isCorrect ? 'Correct' : 'Incorrect'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `
                                <tr>
                                    <td colspan="5" class="text-center">
                                        No detailed question data available
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
                
                <div class="report-footer">
                    <p class="footer-note">This report was generated by eWings Papers System</p>
                    <p class="footer-contact">Contact: info@ewings.com | Phone: +94 112 345 678</p>
                </div>
            </div>
        `;

        // Append to body (temporarily)
        document.body.appendChild(reportDiv);

        // Generate chart
        const chartCanvas = reportDiv.querySelector('#report-chart');
        const ctx = chartCanvas.getContext('2d');
        const yourScore = Math.round((submission.score / submission.totalMarks) * 100);
        const classAverage = Math.min(100, Math.max(50, yourScore - 10 + Math.floor(Math.random() * 20)));
        const topScore = Math.min(100, yourScore + 10 + Math.floor(Math.random() * 10));
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Knowledge', 'Application', 'Analysis', 'Evaluation'],
                datasets: [
                    {
                        label: 'Your Score',
                        data: [
                            Math.floor(Math.random() * 20) + 60,
                            Math.floor(Math.random() * 20) + 60,
                            Math.floor(Math.random() * 20) + 60,
                            Math.floor(Math.random() * 20) + 60
                        ],
                        backgroundColor: 'rgba(78, 115, 223, 0.7)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Class Average',
                        data: [
                            Math.floor(Math.random() * 20) + 50,
                            Math.floor(Math.random() * 20) + 50,
                            Math.floor(Math.random() * 20) + 50,
                            Math.floor(Math.random() * 20) + 50
                        ],
                        backgroundColor: 'rgba(28, 200, 138, 0.7)',
                        borderColor: 'rgba(28, 200, 138, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Top Score',
                        data: [
                            Math.floor(Math.random() * 10) + 85,
                            Math.floor(Math.random() * 10) + 85,
                            Math.floor(Math.random() * 10) + 85,
                            Math.floor(Math.random() * 10) + 85
                        ],
                        backgroundColor: 'rgba(246, 194, 62, 0.7)',
                        borderColor: 'rgba(246, 194, 62, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Score (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Skill Category'
                        }
                    }
                }
            }
        });

        // PDF options
        const opt = {
            margin: 10,
            filename: `eWings_Report_${paper.title.replace(/\s+/g, '_')}_${user.name || 'Student'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                logging: true,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait' 
            }
        };

        // Generate and download PDF
        await html2pdf().set(opt).from(reportDiv).save();

        if (reportDiv && reportDiv.parentNode) {
          reportDiv.parentNode.removeChild(reportDiv);
        }

    } catch (error) {
        console.error('Error generating report:', error);
        showToast('Failed to generate report: ' + error.message, 'danger');
    } finally {
        // Restore button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
    }
}

// Utility functions
function checkAuthForStats() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) {
        showToast('Please login to view stats', 'warning');
        return false;
    }
    return true;
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.classList.replace('fa-moon', 'fa-sun');
        localStorage.setItem('theme', 'dark');
    } else {
        icon.classList.replace('fa-sun', 'fa-moon');
        localStorage.setItem('theme', 'light');
    }
}

function checkTheme() {
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        const icon = themeToggle.querySelector('i');
        if (icon) {
            icon.classList.replace('fa-moon', 'fa-sun');
        }
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = `toast-container position-fixed top-0 end-0 p-3`;
    toastContainer.style.zIndex = '1100';
    
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type} border-0`;
    toast.role = 'alert';
    toast.ariaLive = 'assertive';
    toast.ariaAtomic = 'true';
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toastContainer.remove(), 300);
    }, 5000);
}

function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const loginSpinner = document.getElementById('loginSpinner');
    const loginError = document.getElementById('loginError');
    
    if (!email || !password) {
        showError(loginError, 'Enter email and password.');
        return;
    }
    loginSpinner?.classList.remove('d-none');
    loginError?.classList.add('d-none');
    auth.signInWithEmailAndPassword(email, password)
        .then(async userCredential => {
            // Check if user is banned
            const bannedRef = database.ref('bannedUsers/' + userCredential.user.uid);
            const bannedSnap = await bannedRef.once('value');
            if (bannedSnap.exists()) {
                await auth.signOut();
                showError(loginError, 'Your account is banned.');
                loginSpinner?.classList.add('d-none');
                throw new Error('banned');
            }
            // Get user data from database
            return database.ref('users/' + userCredential.user.uid).once('value')
                .then(snapshot => {
                    let userData = snapshot.val();
                    if (!userData) {
                        userData = {
                            name: email.split('@')[0],
                            email: email,
                            nic: '',
                            class: '',
                            registeredYear: new Date().getFullYear().toString()
                        };
                        return database.ref('users/' + userCredential.user.uid).set(userData)
                            .then(() => userData);
                    }
                    return userData;
                })
                .then(userData => {
                    localStorage.setItem('currentUser', JSON.stringify({
                        uid: userCredential.user.uid,
                        email: userCredential.user.email,
                        ...userData
                    }));
                    const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    modal?.hide();
                    showToast(`Welcome, ${userData.name || 'User'}!`, 'success');
                    updateUserUI(userCredential.user, userData);
                    loadInitialContent(userData.registeredYear);
                });
        })
        .catch(error => {
            if (error.message === 'banned') return;
            showError(loginError, getSimpleAuthError(error));
        })
        .finally(() => {
            loginSpinner?.classList.add('d-none');
        });
}

// Simplified error display for login
function showError(element, message) {
    if (!element) return;
    element.textContent = message;
    element.classList.remove('d-none');
    element.classList.add('show');
    setTimeout(() => {
        element.classList.add('d-none');
    }, 4000);
}

// Simplified error messages for login
function getSimpleAuthError(error) {
    if (!error || !error.code) return 'Login failed.';
    switch (error.code) {
        case 'auth/user-not-found':
        case 'auth/wrong-password':
            return 'Invalid email or password.';
        case 'auth/too-many-requests':
            return 'Too many attempts. Try again later.';
        case 'auth/network-request-failed':
            return 'Network error. Check your connection.';
        case 'auth/user-disabled':
            return 'Account is disabled.';
        default:
            return 'Login failed.';
    }
}

// Setup filter dropdown
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            document.querySelectorAll('[data-filter]').forEach(i => 
                i.classList.remove('active')
            );
            this.classList.add('active');
            
            // Get filter type
            const filterType = this.getAttribute('data-filter');
            
            // Apply filter
            if (window.userSubmissions) {
                displaySubmissionsTable(window.userSubmissions, filterType);
            }
        });
    });
    
    // Initialize when stats section is shown
    document.getElementById('statsSection').addEventListener('show', function() {
        loadUserStats();
    });
    
    // Load html2pdf library dynamically
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    script.async = true;
    document.head.appendChild(script);
});

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal if it exists
    if (document.getElementById('submissionDetailsModal')) {
        window.submissionModal = new bootstrap.Modal(
            document.getElementById('submissionDetailsModal')
        );
    }
});

// In your view button event listener:
console.log('View button clicked');
console.log('Paper ID:', paperId);
console.log('Submissions data:', submissions);
console.log('Found submission:', submission);

// In your showSubmissionDetails function:
console.log('Showing submission details:', submission);

if (!window.submissionModal && document.getElementById('submissionDetailsModal')) {
    window.submissionModal = new bootstrap.Modal(
        document.getElementById('submissionDetailsModal')
    );
}


document.addEventListener('DOMContentLoaded', function() {
  const profileModal = document.getElementById('profileModal');
  if (profileModal) {
    profileModal.addEventListener('show.bs.modal', function() {
      if (window.innerWidth < 992) {
        // Close sidebar if open
        document.getElementById('sidebar').classList.remove('toggled');
        document.getElementById('content').classList.remove('toggled');
      }
    });
  }
  
  // Handle mobile menu button when modal is open
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', function() {
      if (document.querySelector('.modal.show')) {
        // If modal is open, close it first
        bootstrap.Modal.getInstance(document.querySelector('.modal.show')).hide();
      }
    });
  }
});

function calculateTopSchools(submissionsArray, selectedClass = null) {
  // Count school occurrences in top submissions
  const schoolCounts = {};
  const classSchoolCounts = {};
  
  // Process top 100 overall submissions for overall top school
  const topOverall = submissionsArray.slice(0, 100);
  topOverall.forEach(sub => {
    if (sub.school) {
      schoolCounts[sub.school] = (schoolCounts[sub.school] || 0) + 1;
    }
  });
  
  // Process top 50 class submissions for class top school
  const topClass = selectedClass 
    ? submissionsArray.filter(sub => sub.class === selectedClass).slice(0, 50)
    : [];
    
  topClass.forEach(sub => {
    if (sub.school) {
      classSchoolCounts[sub.school] = (classSchoolCounts[sub.school] || 0) + 1;
    }
  });
  
  // Find overall top school
  let overallTopSchool = "N/A";
  let maxCount = 0;
  for (const [school, count] of Object.entries(schoolCounts)) {
    if (count > maxCount) {
      maxCount = count;
      overallTopSchool = school;
    }
  }
  
  // Find class top school
  let classTopSchool = "N/A";
  let classMaxCount = 0;
  for (const [school, count] of Object.entries(classSchoolCounts)) {
    if (count > classMaxCount) {
      classMaxCount = count;
      classTopSchool = school;
    }
  }
  
  return { overallTopSchool, classTopSchool };
}

function displayTopSchools(overallTopSchool, classTopSchool, selectedClass = null) {
  const overallElement = document.getElementById('overallTopSchool');
  const classElement = document.getElementById('classTopSchool');
  
  if (overallElement) {
    overallElement.innerHTML = `
      <h3 class="mb-2">${overallTopSchool || 'N/A'}</h3>
      <p class="text-muted small">Top performing school in overall rankings</p>
    `;
  }
  
  if (classElement) {
    classElement.innerHTML = `
      <h3 class="mb-2">${classTopSchool || 'N/A'}</h3>
      <p class="text-muted small">Top performing school in ${selectedClass || 'selected class'}</p>
    `;
  }
}

document.getElementById('downloadChartBtn')?.addEventListener('click', async function() {
    // Show loading state
    const originalText = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Preparing...';
    this.disabled = true;
    
    try {
        await exportChartToPDF('paperClassPerformanceChart', 'performance-report.pdf');
    } catch (error) {
        console.error('Export failed:', error);
        showToast('Failed to generate PDF', 'danger');
    } finally {
        // Restore button state
        this.innerHTML = originalText;
        this.disabled = false;
    }
});

async function exportChartToPDF(canvasId, filename = 'chart.pdf') {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        showToast('Chart not found', 'danger');
        return;
    }

    try {
        // Test if we can export directly
        canvas.toDataURL('image/png');
        
        // If no error, proceed with direct export
        const { jsPDF } = await loadPDFLibrary();
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
            unit: 'mm'
        });
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(filename);
    } catch (error) {
        console.warn('Direct export failed, using fallback:', error);
        await exportChartFallback(canvasId, filename);
    }
}

async function loadPDFLibrary() {
    return new Promise((resolve) => {
        if (window.jspdf) {
            resolve({ jsPDF: window.jspdf.jsPDF });
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => resolve({ jsPDF: window.jspdf.jsPDF });
        document.head.appendChild(script);
    });
}

async function exportChartFallback(canvasId, filename) {
    try {
        const { jsPDF } = await loadPDFLibrary();
        const { createCanvas, loadImage } = await import('canvas'); // Node.js canvas
        
        // Create a clean canvas and redraw
        const originalCanvas = document.getElementById(canvasId);
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = originalCanvas.width;
        tempCanvas.height = originalCanvas.height;
        const ctx = tempCanvas.getContext('2d');
        
        // Fill with white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Redraw chart
        ctx.drawImage(originalCanvas, 0, 0);
        
        // Export to PDF
        const imgData = tempCanvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: tempCanvas.width > tempCanvas.height ? 'landscape' : 'portrait',
            unit: 'mm'
        });
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(filename);
    } catch (error) {
        console.error('Fallback export failed:', error);
        showToast('Failed to export chart. Please try another browser.', 'danger');
    }
}

async function calculateRanks(paperId, nic) {
    const submissionsSnapshot = await database.ref(`submissions/${paperId}`).once('value');
    const allSubmissions = submissionsSnapshot.val() || {};
    let submissionsArray = Object.entries(allSubmissions).map(([nic, sub]) => ({ nic, ...sub }));
    
    // Sort and calculate ranks
    submissionsArray.sort((a, b) => b.score - a.score);
    
    let rank = 1;
    submissionsArray.forEach((sub, i) => {
        if (i > 0 && sub.score < submissionsArray[i-1].score) rank = i + 1;
        sub.rank = rank;
    });
    
    // Find the user's submission
    const userSubmission = submissionsArray.find(sub => sub.nic === nic);
    
    // Calculate class rank if applicable
    let classRank = null;
    const user = JSON.parse(localStorage.getItem('currentUser')) || {};
    if (user.class && userSubmission) {
        const classSubmissions = submissionsArray.filter(sub => sub.class === user.class);
        let cr = 1;
        classSubmissions.forEach((sub, i) => {
            if (i > 0 && sub.score < classSubmissions[i-1].score) cr = i + 1;
            sub.classRank = cr;
            
            if (sub.nic === nic) {
                classRank = cr;
            }
        });
    }
    
    return {
        overallRank: userSubmission?.rank || null,
        classRank: classRank
    };
}



//paper class =======================================================================






// Check if user is verified for Paper Class
async function checkAuthForPaperClass() {
    const forceCheck = new URLSearchParams(window.location.search).has('forceCheck');
    if (forceCheck) {
        localStorage.removeItem('currentUser');
        window.location.href = window.location.pathname; // Reload without the parameter
    }

    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) {
        showToast('Please login to access Paper Class', 'warning');
        return false;
    }
    
    try {
        // Get fresh user data from database to ensure we have latest status
        const snapshot = await database.ref('users/' + user.uid).once('value');
        const userData = snapshot.val();
        
        if (!userData) {
            showToast('User data not found', 'warning');
            return false;
        }
        
        // Check all required conditions
        const hasPaperClassAccess = userData.classTypes && 
                                  userData.classTypes.includes('Paper Class');
        const isActive = !userData.inactive;
        const isVerified = userData.verified === true;
        const isPaid = userData.isPaid === true;
        
        if (!hasPaperClassAccess) {
            showToast('You are not enrolled in Paper Class', 'warning');
            return false;
        }
        
        if (!isActive) {
            showToast('Your account is inactive', 'warning');
            return false;
        }
        
        if (!isVerified) {
            showToast('Only verified students can access Paper Class', 'warning');
            return false;
        }
        
        if (!isPaid) {
            showToast('Please complete your payment to access Paper Class', 'warning');
            return false;
        }
        
        // Update localStorage with current verification status
        if (userData.verified !== user.verified || 
            userData.inactive !== user.inactive ||
            userData.isPaid !== user.isPaid) {
            user.verified = userData.verified;
            user.inactive = userData.inactive;
            user.isPaid = userData.isPaid;
            localStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        return true;
    } catch (error) {
        console.error('Error checking verification:', error);
        showToast('Error checking your access status', 'danger');
        return false;
    }
}

// Load Paper Class papers
async function loadPaperClassPapers() {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return;
        
        // Show loading state
        document.getElementById('paperClassActivePapersContainer').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Loading active papers...</p>
            </div>
        `;
        
        document.getElementById('paperClassViewPapersContainer').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Loading papers...</p>
            </div>
        `;
        
        // Get papers filtered by user's registered year
        const snapshot = await database.ref('paperClassPapers').once('value');
        const papers = snapshot.val() || {};
        const now = new Date().getTime();
        
        let activePapersHtml = '';
        let viewPapersHtml = '';
        let hasActivePapers = false;
        let hasViewPapers = false;
        
        // Process papers
        for (const [id, paper] of Object.entries(papers)) {
            // Filter by user's registered year
            if (paper.year !== user.registeredYear) continue;
            
            // Get submission data for this paper
            const submissionSnapshot = await database.ref(`paperClassSubmissions/${id}/${user.nic}`).once('value');
            if (submissionSnapshot.exists()) {
                paper.submissions = { [user.nic]: submissionSnapshot.val() };
            }
            
            const openTime = new Date(paper.openTime).getTime();
            const closeTime = new Date(paper.closeTime).getTime();
            
            const card = createPaperClassPaperCard(id, paper, now >= openTime && now <= closeTime);
            
            if (now >= openTime && now <= closeTime) {
                activePapersHtml += card;
                hasActivePapers = true;
            } else {
                viewPapersHtml += card;
                hasViewPapers = true;
            }
        }
        
        // Update UI
        document.getElementById('paperClassActivePapersContainer').innerHTML = 
            hasActivePapers ? activePapersHtml : `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No active papers available</p>
                </div>
            `;
            
        document.getElementById('paperClassViewPapersContainer').innerHTML = 
            hasViewPapers ? viewPapersHtml : `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No papers found</p>
                </div>
            `;
            
        // Add event listeners to new cards
        addPaperClassCardEventListeners();
        
    } catch (error) {
        console.error('Error loading Paper Class papers:', error);
        showToast('Failed to load Paper Class papers', 'danger');
        
        document.getElementById('paperClassActivePapersContainer').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle display-5 mb-3"></i>
                <p>Error loading papers</p>
            </div>
        `;
    }
}

// Create Paper Class paper card
function createPaperClassPaperCard(id, paper, isActive) {
    const openTime = new Date(paper.openTime);
    const closeTime = new Date(paper.closeTime);
    
    const user = JSON.parse(localStorage.getItem('currentUser'));
    const hasSubmission = user && user.nic && paper.submissions && paper.submissions[user.nic];
    
    let buttons = '';
    if (isActive) {
        buttons = `
            <div class="btn-group w-100 mb-2">
                <button class="btn btn-outline-primary download-paper-class-btn" data-id="${id}" data-medium="sinhala">
                    <i class="bi bi-download me-1"></i> Sinhala Paper
                </button>
                <button class="btn btn-outline-primary download-paper-class-btn" data-id="${id}" data-medium="english">
                    <i class="bi bi-download me-1"></i> English Paper
                </button>
            </div>
            <a href="paper-class-student.html?paperId=${id}" class="btn btn-primary w-100">
                <i class="bi bi-send me-1"></i> Submit Answers
            </a>
        `;
    } else {
        buttons = `
            <div class="btn-group w-100 mb-2">
                <button class="btn btn-outline-primary download-paper-class-btn" data-id="${id}" data-medium="sinhala">
                    <i class="bi bi-download me-1"></i> Sinhala
                </button>
                <button class="btn btn-outline-primary download-paper-class-btn" data-id="${id}" data-medium="english">
                    <i class="bi bi-download me-1"></i> English
                </button>
            </div>
            <div class="btn-group w-100 mb-2">
                <button class="btn btn-outline-success flex-grow-1 download-paper-class-answers-btn" data-id="${id}">
                    <i class="bi bi-file-earmark-text me-1"></i> Answers
                </button>
                <button class="btn btn-primary flex-grow-1 view-paper-class-ranks-btn" data-id="${id}">
                    <i class="bi bi-trophy me-1"></i> Rankings
                </button>
            </div>
            <div class="btn-group w-100 mb-1">
                ${hasSubmission ? `
                <button class="btn btn-info view-paper-class-answers-btn" data-id="${id}">
                    <i class="bi bi-eye me-1"></i> My Answers
                </button>
                ` : ''}
                <button class="btn btn-sm btn-outline-secondary share-rankings-btn mt-2" data-id="${id}">
                    <i class="bi bi-share me-1"></i> Share Rankings
                </button>
            </div>
        `;
    }
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">${paper.title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${paper.year} - ${paper.subject}</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-${isActive ? 'success' : 'secondary'}">
                            ${isActive ? 'Active' : 'Closed'}
                        </span>
                        <small class="text-muted">Paper ${paper.paperNumber}</small>
                    </div>
                    <p class="card-text small text-muted">
                        ${isActive ? 
                            `Available until ${closeTime.toLocaleString()}` : 
                            `Closed on ${closeTime.toLocaleString()}`}
                    </p>
                    ${buttons}
                </div>
            </div>
        </div>
    `;
}

// Add event listeners to Paper Class cards
function addPaperClassCardEventListeners() {
    // Download paper buttons
    document.querySelectorAll('.download-paper-class-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-id');
            const medium = this.getAttribute('data-medium');
            downloadPaperClassPaper(paperId, medium);
        });
    });
    
    // Download answer key buttons
    document.querySelectorAll('.download-paper-class-answers-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-id');
            downloadPaperClassAnswers(paperId);
        });
    });
     document.querySelectorAll('.view-paper-class-ranks-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const paperId = this.getAttribute('data-id');
            showSection('paperClassRankings');
            const filter = document.getElementById('paperClassRankingsFilter');
            if (filter) {
                filter.value = paperId;
                const user = JSON.parse(localStorage.getItem('currentUser'));
                await displayPaperClassRankings(paperId, user);
            }
        });
    });

    // View answers button
    document.querySelectorAll('.view-paper-class-answers-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const paperId = this.getAttribute('data-id');
            showStudentPaperAnswers(paperId);
        });
    });

    // Share rankings buttons - use event delegation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.share-rankings-btn')) {
            const btn = e.target.closest('.share-rankings-btn');
            const paperId = btn.getAttribute('data-id');
            sharePaperRankingsLink(paperId);
        }
    });
}

// Download Paper Class paper
async function downloadPaperClassPaper(paperId, medium) {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
            showToast('Please login to download papers', 'warning');
            return;
        }
        
        // Set loading state
        const buttons = document.querySelectorAll(`.download-paper-class-btn[data-id="${paperId}"][data-medium="${medium}"]`);
        buttons.forEach(btn => {
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Downloading...`;
            btn.disabled = true;
        });
        
        // Get paper details
        const paperSnapshot = await database.ref(`paperClassPapers/${paperId}`).once('value');
        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');
        
        // Get download URL
        const url = medium === 'sinhala' ? paper.pdfUrlSinhala : paper.pdfUrlEnglish;
        if (!url) throw new Error('Paper file not available');
        
        // Trigger download
        const a = document.createElement('a');
        a.href = url;
        a.download = `${paper.title.replace(/\s+/g, '_')}-${medium}-${paper.year}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast(`${medium === 'sinhala' ? 'Sinhala' : 'English'} paper downloaded`, 'success');
        
    } catch (error) {
        console.error('Download error:', error);
        showToast('Failed to download paper', 'danger');
    } finally {
        // Reset button state
        const buttons = document.querySelectorAll(`.download-paper-class-btn[data-id="${paperId}"][data-medium="${medium}"]`);
        buttons.forEach(btn => {
            btn.innerHTML = `<i class="bi bi-download me-1"></i> ${medium === 'sinhala' ? 'Sinhala' : 'English'}`;
            btn.disabled = false;
        });
    }
}

// Download Paper Class answer key
async function downloadPaperClassAnswers(paperId) {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
            showToast('Please login to download answers', 'warning');
            return;
        }
        
        // Set loading state
        const buttons = document.querySelectorAll(`.download-paper-class-answers-btn[data-id="${paperId}"]`);
        buttons.forEach(btn => {
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Downloading...`;
            btn.disabled = true;
        });
        
        // Get paper details
        const paperSnapshot = await database.ref(`paperClassPapers/${paperId}`).once('value');
        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');
        
        if (!paper.answerKeyUrl) {
            throw new Error('Answer key not available');
        }
        
        // Trigger download
        const a = document.createElement('a');
        a.href = paper.answerKeyUrl;
        a.download = `${paper.title.replace(/\s+/g, '_')}-answers-${paper.year}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast('Answer key downloaded', 'success');
        
    } catch (error) {
        console.error('Download error:', error);
        showToast('Failed to download answer key', 'danger');
    } finally {
        // Reset button state
        const buttons = document.querySelectorAll(`.download-paper-class-answers-btn[data-id="${paperId}"]`);
        buttons.forEach(btn => {
            btn.innerHTML = `<i class="bi bi-file-earmark-text me-1"></i> Answers`;
            btn.disabled = false;
        });
    }
}

//paper class rankings system ==========================================================
//check authentication for Paper Class Rankings
async function checkAuthForPaperClassRankings() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) {
        showToast('Please login to access Paper Class Rankings', 'warning');
        return false;
    }
    
    // Check if user is in a paper class
    if (!user.classTypes || !user.classTypes.includes('Paper Class')) {
        showToast('Only Paper Class students can access this section', 'warning');
        return false;
    }
    
    return true;
}

// to load Paper Class Rankings
async function loadPaperClassRankings() {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || !user.studentId) {
            showToast('Please login to view rankings', 'warning');
            return;
        }

        // Show loading states
        showRankingsLoadingState();

        // Get all paper class rankings and papers
        const [rankingsSnapshot, papersSnapshot] = await Promise.all([
            database.ref('paperClassRankings').once('value'),
            database.ref('paperClassPapers').once('value')
        ]);

        const allRankings = rankingsSnapshot.val() || {};
        const allPapers = papersSnapshot.val() || {};

        // Populate paper filter dropdown
        const filter = document.getElementById('paperClassRankingsFilter');
        filter.innerHTML = '<option value="">All Papers</option>';
        
        // Only show papers that have published rankings
        Object.entries(allRankings).forEach(([paperId, paperData]) => {
            if (paperData.batches && Object.values(paperData.batches).some(batch => batch.published)) {
                const paperTitle = allPapers[paperId]?.title || `Paper ${paperId}`;
                const option = document.createElement('option');
                option.value = paperId;
                option.textContent = paperTitle;
                filter.appendChild(option);
            }
        });

        // Load initial rankings (all papers by default)
        await displayPaperClassRankings('', user, allRankings, allPapers);

        // Add event listener for filter changes
        filter.addEventListener('change', async () => {
    if (filter.value === "") {
        // When "All Papers" is selected, show performance section
        showSection('paperClassPerformance');
        await loadPaperClassPerformance();
    } else {
        await displayPaperClassRankings(filter.value, user, allRankings, allPapers);
    }
});
    } catch (error) {
        console.error('Error loading paper class rankings:', error);
        showToast('Failed to load rankings', 'danger');
        showRankingsErrorState();
    }
}

// Helper function to show loading state
function showRankingsLoadingState() {
    document.getElementById('paperClassOverallTopStudent').innerHTML = '<div class="spinner-border"></div>';
    document.getElementById('paperClassClassTopStudent').innerHTML = '<div class="spinner-border"></div>';
    document.getElementById('paperClassOverallRankings').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border"></div></td></tr>';
    document.getElementById('paperClassClassRankings').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border"></div></td></tr>';
    document.getElementById('paperClassUserRankInfo').style.display = 'none';
}

// Helper function to show error state
function showRankingsErrorState() {
    const errorHTML = '<div class="text-center text-danger py-3"><i class="bi bi-exclamation-triangle"></i><p>Failed to load rankings</p></div>';
    document.getElementById('paperClassOverallTopStudent').innerHTML = errorHTML;
    document.getElementById('paperClassClassTopStudent').innerHTML = errorHTML;
    document.getElementById('paperClassOverallRankings').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
    document.getElementById('paperClassClassRankings').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
}

async function displayPaperClassRankings(paperId, user, allRankings, allPapers) {
    try {
        showRankingsLoadingState();

        // Get all user data for school information
        const usersSnapshot = await database.ref('users').once('value');
        const allUsers = usersSnapshot.val() || {};

        // Create student-school mapping
        const studentSchoolMap = {};
        Object.entries(allUsers).forEach(([uid, userData]) => {
            if (userData.studentId) {
                studentSchoolMap[userData.studentId] = {
                    school: userData.school || 'Unknown School',
                    name: userData.name || 'Unknown Student',
                    class: userData.class || 'Unknown Class'
                };
            }
        });

        // Process rankings data
        let allScores = [];
        const papersToProcess = paperId ? { [paperId]: allRankings[paperId] } : allRankings;

        Object.entries(papersToProcess).forEach(([currentPaperId, paperData]) => {
            if (paperData?.batches) {
                Object.values(paperData.batches).forEach(batch => {
                    if (batch.published && batch.scores) {
                        Object.values(batch.scores).forEach(score => {
                            const studentInfo = studentSchoolMap[score.studentId] || {};
                            allScores.push({
                                ...score,
                                name: studentInfo.name || score.name || 'Unknown Student',
                                school: studentInfo.school || score.school || 'Unknown School',
                                class: studentInfo.class || score.class || 'Unknown Class',
                                paperId: currentPaperId,
                                batchId: batch.batchId,
                                paperTitle: allPapers[currentPaperId]?.title || `Paper ${currentPaperId}`
                            });
                        });
                    }
                });
            }
        });

        if (allScores.length === 0) {
            showNoRankingsAvailable();
            return;
        }

        // Calculate ranks
        calculateRanks(allScores);

        // Display results
        displayRankingsResults(allScores, user);
        
    } catch (error) {
        console.error('Error displaying rankings:', error);
        showToast('Failed to display rankings', 'danger');
        showRankingsErrorState();
    }
}

// Helper function to calculate ranks
function calculateRanks(allScores) {
    // Sort all scores by score (descending)
    allScores.sort((a, b) => b.score - a.score);

    // Assign overall ranks
    let overallRank = 1;
    allScores.forEach((score, index) => {
        if (index > 0 && score.score < allScores[index - 1].score) {
            overallRank = index + 1;
        }
        score.overallRank = overallRank;
    });

    // Group scores by class and assign class ranks
    const classGroups = {};
    allScores.forEach(score => {
        if (!classGroups[score.class]) {
            classGroups[score.class] = [];
        }
        classGroups[score.class].push(score);
    });

    Object.values(classGroups).forEach(classScores => {
        classScores.sort((a, b) => b.score - a.score);
        let classRank = 1;
        classScores.forEach((score, index) => {
            if (index > 0 && score.score < classScores[index - 1].score) {
                classRank = index + 1;
            }
            score.classRank = classRank;
        });
    });
}

// Helper function to display rankings results
function displayRankingsResults(allScores, user) {
    // Get user's class from scores (in case it's different from profile)
    const userClass = allScores.find(s => s.studentId === user.studentId)?.class || user.class;
    
    // Filter scores for user's class
    const classScores = allScores.filter(score => score.class === userClass);

    // Display top students
    displayTopStudents(allScores, classScores, userClass);

    // Display rankings tables
    displayRankingsTable(allScores.slice(0, 100), 'paperClassOverallRankings');
    displayRankingsTable(classScores.slice(0, 100), 'paperClassClassRankings');

    // Show user's rank if available
    showUserRankInfo(allScores, classScores, user);
}

// Helper function to display top students
function displayTopStudents(allScores, classScores, userClass) {
    const overallTop = allScores[0] || null;
    const classTop = classScores[0] || null;

    document.getElementById('paperClassOverallTopStudent').innerHTML = overallTop ? `
        <div class="text-center">
            <div class="school-badge bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                <i class="bi bi-trophy-fill fs-4"></i>
            </div>
            <h5 class="mb-1">${overallTop.name}</h5>
            <p class="text-muted small mb-0">${overallTop.school}</p>
            <p class="text-muted small">Score: ${overallTop.score}</p>
        </div>
    ` : '<div class="text-center text-muted">No top student data</div>';

    document.getElementById('paperClassClassTopStudent').innerHTML = classTop ? `
        <div class="text-center">
            <div class="school-badge bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                <i class="bi bi-award-fill fs-4"></i>
            </div>
            <h5 class="mb-1">${classTop.name}</h5>
            <p class="text-muted small mb-0">${classTop.school}</p>
            <p class="text-muted small">Score: ${classTop.score}</p>
        </div>
    ` : `<div class="text-center text-muted">No top student in ${userClass}</div>`;
}

// Helper function to show no rankings available
function showNoRankingsAvailable() {
    const noDataHTML = `
        <div class="text-center text-muted py-3">
            <i class="bi bi-info-circle fs-1"></i>
            <p class="mt-2">No ranking data available</p>
        </div>
    `;
    document.getElementById('paperClassOverallTopStudent').innerHTML = noDataHTML;
    document.getElementById('paperClassClassTopStudent').innerHTML = noDataHTML;
    document.getElementById('paperClassOverallRankings').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No rankings found</td></tr>';
    document.getElementById('paperClassClassRankings').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No rankings found</td></tr>';
}

function displayRankingsTable(scores, tableId) {
    const tableBody = document.getElementById(tableId);
    tableBody.innerHTML = '';

    if (!scores || scores.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No rankings found</td></tr>';
        return;
    }

    tableBody.innerHTML = scores.map((score, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${score.name}</td>
            <td>${score.score}</td>
            <td>${score.school}</td>
        </tr>
    `).join('');
}

// Helper function to show user rank info
function showUserRankInfo(allScores, classScores, user) {
    const userOverallScore = allScores.find(score => score.nic === user.nic);
    const userClassScore = classScores.find(score => score.nic === user.nic);
    
    const rankDetails = document.getElementById('paperClassUserRankDetails');
    rankDetails.innerHTML = '';
    
    if (userOverallScore || userClassScore) {
        document.getElementById('paperClassUserRankInfo').style.display = 'block';
        
        if (userOverallScore) {
            rankDetails.innerHTML += `
                <div class="d-flex justify-content-between">
                    <span>Overall Rank:</span>
                    <strong>${userOverallScore.overallRank}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Score:</span>
                    <strong>${userOverallScore.score}</strong>
                </div>
            `;
        }
        
        if (userClassScore) {
            rankDetails.innerHTML += `
                <div class="d-flex justify-content-between">
                    <span>Class Rank:</span>
                    <strong>${userClassScore.classRank}</strong>
                </div>
            `;
        }
    } else {
        document.getElementById('paperClassUserRankInfo').style.display = 'none';
    }
}


async function calculateTopSchoolsRank(submissionsArray, selectedClass = null) {
    // Get all student data first
    const studentIds = submissionsArray.map(sub => sub.studentId).filter(id => id);
    const usersSnapshot = await database.ref('users').once('value');
    const allUsers = usersSnapshot.val() || {};

    // Create student-school mapping
    const studentSchoolMap = {};
    Object.values(allUsers).forEach(user => {
        if (user.studentId) {
            studentSchoolMap[user.studentId] = user.school || 'Unknown School';
        }
    });

    // Initialize counters
    const schoolCounts = {};
    const classSchoolCounts = {};
    
    // Process all submissions to count school occurrences
    submissionsArray.forEach(sub => {
        // Get school from mapping if available, otherwise use the one in the score object
        const school = studentSchoolMap[sub.studentId] || sub.school || 'Unknown School';
        
        // Count for overall rankings
        schoolCounts[school] = (schoolCounts[school] || 0) + 1;
        
        // Count for class rankings if class matches
        if (selectedClass && sub.class === selectedClass) {
            classSchoolCounts[school] = (classSchoolCounts[school] || 0) + 1;
        }
    });
    
    // Find overall top school
    let overallTopSchool = "N/A";
    let maxCount = 0;
    for (const [school, count] of Object.entries(schoolCounts)) {
        if (count > maxCount) {
            maxCount = count;
            overallTopSchool = school;
        }
    }
    
    // Find class top school
    let classTopSchool = "N/A";
    let classMaxCount = 0;
    for (const [school, count] of Object.entries(classSchoolCounts)) {
        if (count > classMaxCount) {
            classMaxCount = count;
            classTopSchool = school;
        }
    }
    
    return { 
        overallTopSchool: overallTopSchool || "N/A", 
        classTopSchool: classTopSchool || "N/A" 
    };
}

function displayTopSchoolsRank(overallTopSchool, classTopSchool, selectedClass = null) {
    const overallElement = document.getElementById('paperClassOverallTopStudent');
    const classElement = document.getElementById('paperClassClassTopStudent');
    
    if (overallElement) {
        overallElement.innerHTML = `
            <div class="text-center">
                <div class="school-badge bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                    <i class="bi bi-trophy-fill fs-4"></i>
                </div>
                <h4 class="mb-1">${overallTopSchool}</h4>
                <p class="text-muted small mb-0">Top School Overall</p>
            </div>
        `;
    }
    
    if (classElement) {
        classElement.innerHTML = `
            <div class="text-center">
                <div class="school-badge bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                    <i class="bi bi-award-fill fs-4"></i>
                </div>
                <h4 class="mb-1">${classTopSchool}</h4>
                <p class="text-muted small mb-0">Top in ${selectedClass || 'Your Class'}</p>
            </div>
        `;
    }
}



// Student Paper class Performance ============================================================
async function loadPaperClassPerformance() {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || !user.nic) {
            showToast('Please login to view performance', 'warning');
            return;
        }
        
        // Show loading state
        document.getElementById('paperClassPerformanceChart').innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
        
        // Get user's paper class submissions
        const submissionsSnapshot = await database.ref(`paperClassSubmissions`).once('value');
        const allSubmissions = submissionsSnapshot.val() || {};
        
        // Process submissions to get user's scores
        const userPaperScores = [];
        for (const [paperId, paperData] of Object.entries(allSubmissions)) {
            if (paperData[user.nic]) {
                const submission = paperData[user.nic];
                userPaperScores.push({
                    paperId,
                    paperNumber: submission.paperNumber || 0,
                    percentage: submission.score || 0,
                    date: submission.submittedAt || 0
                });
            }
        }
        
        // Update performance cards
        updatePaperClassPerformanceCards(userPaperScores, Object.keys(allSubmissions).length);
        
        // Initialize chart with actual data
        await initializePaperClassPerformanceChart(userPaperScores);
        
        // Update recent papers table
        await updatePaperClassRecentPapersTable(userPaperScores, user);

        // Show loading states...

        // Get all data in parallel for better performance
        const [rankingsSnapshot, papersSnapshot, usersSnapshot] = await Promise.all([
            database.ref('paperClassRankings').once('value'),
            database.ref('paperClassPapers').once('value'),
            database.ref('users').once('value')
        ]);

        const allRankings = rankingsSnapshot.val() || {};
        const allPapers = papersSnapshot.val() || {};
        const allUsers = usersSnapshot.val() || {};

        // Create student-school mapping by NIC
        const studentSchoolMap = {};
        Object.entries(allUsers).forEach(([uid, userData]) => {
            if (userData.nic) {
                studentSchoolMap[userData.nic] = {
                    name: userData.name || 'Unknown Student',
                    school: userData.school || 'Unknown School',
                    class: userData.class || 'Unknown Class'
                };
            }
        });

        // Process all rankings to find user's scores
        let userScores = [];
        let totalPossiblePapers = 0;

        for (const [paperId, paperData] of Object.entries(allRankings)) {
            if (paperData.batches) {
                totalPossiblePapers++;
                for (const [batchId, batch] of Object.entries(paperData.batches)) {
                    if (batch.published && batch.scores) {
                        const userScore = Object.values(batch.scores).find(
                            score => score.nic === user.nic
                        );
                        if (userScore) {
                            const paperInfo = allPapers[paperId] || {};
                            const studentInfo = studentSchoolMap[user.nic] || {};
                            // Calculate ranks for this paper batch
                            const allBatchScores = Object.values(batch.scores).map(score => ({
                                ...score,
                                name: studentSchoolMap[score.nic]?.name || score.name || 'Unknown',
                                school: studentSchoolMap[score.nic]?.school || score.school || 'Unknown',
                                class: studentSchoolMap[score.nic]?.class || score.class || 'Unknown'
                            }));
                            // Sort and rank
                            allBatchScores.sort((a, b) => b.score - a.score);
                            // Calculate overall rank
                            let overallRank = 1;
                            allBatchScores.forEach((score, index) => {
                                if (index > 0 && score.score < allBatchScores[index - 1].score) {
                                    overallRank = index + 1;
                                }
                                score.overallRank = overallRank;
                            });
                            // Calculate class rank
                            const classScores = allBatchScores.filter(s => s.class === studentInfo.class);
                            let classRank = 1;
                            classScores.forEach((score, index) => {
                                if (index > 0 && score.score < classScores[index - 1].score) {
                                    classRank = index + 1;
                                }
                                score.classRank = classRank;
                            });
                            // Find user's specific ranks
                            const userOverallRank = allBatchScores.find(s => s.nic === user.nic)?.overallRank || 'N/A';
                            const userClassRank = classScores.find(s => s.nic === user.nic)?.classRank || 'N/A';
                            // Get paper date from paper info (creation date)
                            const paperDate = paperInfo.createdAt || paperInfo.paperDate || Date.now();
                            userScores.push({
                                paperId,
                                batchId,
                                paperTitle: paperInfo.title || 'Unknown Paper',
                                paperNumber: paperInfo.paperNumber || '',
                                date: paperDate,
                                formattedDate: formatDate(paperDate),
                                score: userScore.score || 0,
                                totalMarks: userScore.totalMarks || 100,
                                classRank: userClassRank,
                                overallRank: userOverallRank,
                                percentage: (userScore.score / (userScore.totalMarks || 100) * 100).toFixed(1)
                            });
                            break; // Only need one score per paper
                        }
                    }
                }
            }
        }

        // Sort by paper number (ascending) for correct order
        userScores.sort((a, b) => a.paperNumber - b.paperNumber);

        // Update UI
        updatePaperClassPerformanceCards(userScores, totalPossiblePapers);
        initializePaperClassPerformanceChart(userScores);
        updatePaperClassRecentPapersTable(userScores, user);

    } catch (error) {
        console.error('Error loading Paper Class performance:', error);
        showToast('Failed to load performance data', 'danger');
    }
}

// Helper function to format dates
function formatDate(timestamp) {
    const date = new Date(timestamp);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function updatePaperClassPerformanceCards(scores, totalPapers) {
    const papersTakenElement = document.getElementById('paperClassPapersTaken');
    const averageScoreElement = document.getElementById('paperClassAverageScore');
    const lastScoreElement = document.getElementById('paperClassLastScore');
    const improvementElement = document.getElementById('paperClassImprovement');
    const improvementIcon = document.getElementById('improvementIcon');

    if (scores.length > 0) {
        // Papers Taken
        papersTakenElement.textContent = `${scores.length}/${totalPapers}`;

        // Average Score
        const totalPercentage = scores.reduce((sum, score) => sum + parseFloat(score.percentage), 0);
        const averagePercentage = (totalPercentage / scores.length).toFixed(1);
        averageScoreElement.textContent = `${averagePercentage}%`;

        // Last Score (most recent)
        const lastScore = scores[scores.length - 1]; // Get the last item (most recent)
        lastScoreElement.textContent = `${lastScore.percentage}%`;

        // Improvement (compare last paper with previous one)
        if (scores.length >= 2) {
            const currentScore = parseFloat(scores[scores.length - 1].percentage); // Most recent
            const previousScore = parseFloat(scores[scores.length - 2].percentage); // Previous
            const improvement = currentScore - previousScore;
            
            improvementElement.textContent = `${improvement >= 0 ? '+' : ''}${improvement.toFixed(1)}%`;
            
            if (improvement >= 0) {
                improvementIcon.className = 'bi bi-arrow-up-right stat-icon text-success';
            } else {
                improvementIcon.className = 'bi bi-arrow-down-right stat-icon text-danger';
            }
        } else {
            improvementElement.textContent = 'N/A';
            improvementIcon.className = 'bi bi-dash stat-icon';
        }
    } else {
        papersTakenElement.textContent = '0';
        averageScoreElement.textContent = '0%';
        lastScoreElement.textContent = '0%';
        improvementElement.textContent = '0%';
        improvementIcon.className = 'bi bi-arrow-up-right stat-icon';
    }
}

async function initializePaperClassPerformanceChart(scores) {
    const ctx = document.getElementById('paperClassPerformanceChart');
    if (!ctx) return;
    
    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Sort scores by paper number (ascending)
    const sortedScores = [...scores].sort((a, b) => a.paperNumber - b.pumber);
    
    // Prepare data for chart
    const labels = sortedScores.map(score => `Paper ${score.paperNumber}`);
    const userScores = sortedScores.map(score => score.percentage);
    
    // Get stats for each paper
    const paperStats = await Promise.all(sortedScores.map(async (score) => {
        try {
            const batchesSnapshot = await database.ref(`paperClassRankings/${score.paperId}/batches`).once('value');
            const batches = batchesSnapshot.val() || {};
            
            let allScores = [];
            
            // Process each batch
            Object.values(batches).forEach(batch => {
                if (batch.published && batch.scores) {
                    // Process each student's score
                    Object.values(batch.scores).forEach(studentScore => {
                        // Use the direct score value (not essayScore)
                        if (studentScore.score !== undefined) {
                            allScores.push(parseFloat(studentScore.score));
                        }
                    });
                }
            });
            
            if (allScores.length === 0) {
                return { average: 0, topScore: 0 };
            }
            
            // Calculate average and top score
            const average = allScores.reduce((sum, s) => sum + s, 0) / allScores.length;
            const topScore = Math.max(...allScores);
            
            return {
                average: Math.round(average * 100) / 100,
                topScore: Math.round(topScore * 100) / 100
            };
        } catch (error) {
            console.error('Error calculating stats:', error);
            return { average: 0, topScore: 0 };
        }
    }));
    
    const classAverages = paperStats.map(stats => stats.average);
    const topScores = paperStats.map(stats => stats.topScore);
    
    // Initialize the chart
    ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Your Score (%)',
                    data: userScores,
                    borderColor: 'rgba(78, 115, 223, 1)',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Class Average (%)',
                    data: classAverages,
                    borderColor: 'rgba(28, 200, 138, 1)',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.3,
                    borderDash: [5, 5],
                    borderWidth: 2
                },
                {
                    label: 'Top Score (%)',
                    data: topScores,
                    borderColor: 'rgba(246, 194, 62, 1)',
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    tension: 0.3,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Paper Number'
                    }
                }
            }
        }
    });
}

async function updatePaperClassRecentPapersTable(scores, user) {
    const tableBody = document.getElementById('paperClassRecentPapers');
    if (!tableBody) return;
    
    // Show loading state
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4">
                <div class="spinner-border"></div>
                <p class="mt-2">Loading rankings...</p>
            </td>
        </tr>
    `;

    try {
        // Get all users data for accurate ranking calculation
        const usersSnapshot = await database.ref('users').once('value');
        const allUsers = usersSnapshot.val() || {};

        // Process each paper to get accurate rankings from all published batches
        const papersWithRanks = await Promise.all(scores.map(async (score) => {
            // Get all batches for this paper
            const paperRankingsSnapshot = await database.ref(`paperClassRankings/${score.paperId}/batches`).once('value');
            const batches = paperRankingsSnapshot.val();
            if (!batches) return { ...score, overallRank: 'N/A', classRank: 'N/A' };

            // Aggregate all scores from all published batches for this paper
            let allScores = [];
            Object.values(batches).forEach(batch => {
                if (batch.published && batch.scores) {
                    Object.values(batch.scores).forEach(s => {
                        const studentInfo = allUsers[s.nic] || {};
                        allScores.push({
                            ...s,
                            name: studentInfo.name || s.name || 'Unknown',
                            class: studentInfo.class || s.class || 'Unknown',
                            school: studentInfo.school || s.school || 'Unknown',
                            batchId: batch.batchId
                        });
                    });
                }
            });

            if (allScores.length === 0) return { ...score, overallRank: 'N/A', classRank: 'N/A' };

            // Sort all scores by percentage (descending)
            allScores.sort((a, b) => {
                const aPercentage = (a.score / (a.totalMarks || 100)) * 100;
                const bPercentage = (b.score / (b.totalMarks || 100)) * 100;
                return bPercentage - aPercentage;
            });

            // Calculate overall ranks (handling ties)
            let currentRank = 1;
            let lastPercentage = null;
            allScores.forEach((score, index) => {
                const currentPercentage = (score.score / (score.totalMarks || 100)) * 100;
                if (index > 0 && currentPercentage < lastPercentage) {
                    currentRank = index + 1;
                }
                score.overallRank = currentRank;
                lastPercentage = currentPercentage;
            });

            // Calculate class ranks (filter by user's class)
            const classScores = allScores.filter(s => s.class === user.class);
            currentRank = 1;
            lastPercentage = null;
            classScores.forEach((score, index) => {
                const currentPercentage = (score.score / (score.totalMarks || 100)) * 100;
                if (index > 0 && currentPercentage < lastPercentage) {
                    currentRank = index + 1;
                }
                score.classRank = currentRank;
                lastPercentage = currentPercentage;
            });

            // Find this user's specific ranks
            const userOverall = allScores.find(s => s.nic === user.nic);
            const userClass = classScores.find(s => s.nic === user.nic);

            return {
                ...score,
                overallRank: userOverall?.overallRank || 'N/A',
                classRank: userClass?.classRank || 'N/A',
                // Include additional rank details if needed
                totalParticipants: allScores.length,
                classParticipants: classScores.length
            };
        }));

        // Display only the 5 most recent papers (sorted by date descending)
        const recentScores = [...papersWithRanks].sort((a, b) => b.date - a.date).slice(0, 5);
        
        tableBody.innerHTML = recentScores.map(score => {
            return `
                <tr>
                    <td>${score.paperTitle} (Paper ${score.paperNumber})</td>
                    <td>${score.formattedDate}</td>
                    <td>${score.percentage}%</td>
                    <td>${score.classRank}</td>
                    <td>${score.overallRank}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-paper-rankings-btn" 
                                data-paperid="${score.paperId}">
                            <i class="bi bi-trophy"></i> View Details
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Add click handlers for view rankings buttons
        document.querySelectorAll('.view-paper-rankings-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const paperId = this.getAttribute('data-paperid');
                await navigateToPaperRankings(paperId);
            });
        });

    } catch (error) {
        console.error('Error loading recent paper rankings:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>Failed to load rankings. Please try again later.</p>
                </td>
            </tr>
        `;
    }
}

//handle chart download
function downloadChartAsPNG(chartInstance) {
    try {
        // Create a temporary link element
        const link = document.createElement('a');
        
        // Get the chart as base64 image
        const image = chartInstance.toBase64Image('image/png', 1);
        
        // Set the download attributes
        link.href = image;
        link.download = `paper-class-performance-${new Date().toISOString().split('T')[0]}.png`;
        
        // Trigger the download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Chart downloaded successfully!', 'success');
    } catch (error) {
        console.error('Error downloading chart:', error);
        showToast('Failed to download chart', 'danger');
    }
}

//====================================
//Onlin Paper Submission
//====================================

// Global variables to track paper submission state
let currentPaperSubmission = {
  paperId: null,
  paperData: null,
  currentStep: 1,
  selectedMedium: null
};

// Initialize modals properly
const paperSubmissionModal = new bootstrap.Modal('#paperSubmissionModal', {
  backdrop: 'static', // Prevent closing when clicking outside
  keyboard: false    // Prevent closing with ESC key
});

window.paperSubmissionModal = paperSubmissionModal;

const answerSubmissionModal = new bootstrap.Modal('#answerSubmissionModal', {
  backdrop: 'static',
  keyboard: false
});

// Updated showModal function with visibility checks
function showPaperSubmissionModal() {
  // Reset modal position and visibility
  const modalEl = document.getElementById('paperSubmissionModal');
  modalEl.style.display = 'block';
  modalEl.style.opacity = '1';
  modalEl.style.visibility = 'visible';
  
  // Manually show the backdrop
  document.body.classList.add('modal-open');
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop fade show';
  backdrop.style.zIndex = '1040';
  document.body.appendChild(backdrop);
  
  // Show modal
  paperSubmissionModal.show();
  
  // Force redraw (sometimes needed for visibility)
  setTimeout(() => {
    modalEl.classList.add('show');
    modalEl.style.pointerEvents = 'auto';
  }, 10);
}

// Initialize modal properly
document.addEventListener('DOMContentLoaded', function() {
    const modalEl = document.getElementById('paperSubmissionModal');
    if (!modalEl) {
        console.error('Modal element not found in DOM');
        return;
    }
    
    // Create or get existing modal instance
    window.paperSubmissionModal = window.paperSubmissionModal || 
        new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: false
        });
    
    // Debug
    console.log('Modal initialized:', window.paperSubmissionModal);
    console.log('Modal element:', modalEl);
});

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  initializePaperSubmission();
});

//paper class rankings navigation

async function navigateToPaperRankings(paperId) {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
            showToast('Please login to view rankings', 'warning');
            return;
        }

        // Show loading state
        showRankingsLoadingState();

        // Show the rankings section
        showSection('paperClassRankings');

        // Set the paper filter
        const filter = document.getElementById('paperClassRankingsFilter');
        if (filter) {
            filter.value = paperId;
            
            // Load the rankings data
            const [rankingsSnapshot, papersSnapshot] = await Promise.all([
                database.ref('paperClassRankings').once('value'),
                database.ref('paperClassPapers').once('value')
            ]);

            await displayPaperClassRankings(
                paperId, 
                user, 
                rankingsSnapshot.val() || {}, 
                papersSnapshot.val() || {}
            );
            
            // Update URL without reloading
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('section', 'paperClassRankings');
            newUrl.searchParams.set('paperId', paperId);
            window.history.pushState({}, '', newUrl);
        }
    } catch (error) {
        console.error('Error navigating to paper rankings:', error);
        showToast('Failed to load paper rankings', 'danger');
    }
}

// view answers 
async function showStudentPaperAnswers(paperId) {
    try {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || !user.nic) {
            showToast('Please login to view your answers', 'warning');
            return;
        }

        // Show loading state
        const modalBody = document.getElementById('studentAnswersModalBody');
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Loading your answers...</p>
            </div>
        `;

        // Get paper and submission data
        const [paperSnapshot, submissionSnapshot] = await Promise.all([
            database.ref(`paperClassPapers/${paperId}`).once('value'),
            database.ref(`paperClassSubmissions/${paperId}/${user.nic}`).once('value')
        ]);

        const paper = paperSnapshot.val();
        const submission = submissionSnapshot.val();

        if (!paper || !submission) {
            throw new Error('Your submission data not found');
        }

        let html = `
            <h4 class="mb-4">${paper.title}</h4>
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i> Here are your submitted answers for this paper.
            </div>
        `;

        // Show MCQ answers if available
        if (submission.mcqAnswers && Object.keys(submission.mcqAnswers).length > 0) {
            html += `
                <h5 class="mb-3">MCQ Answers</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Question</th>
                                <th>Your Answer</th>
                                <th>Correct Answer</th>
                                <th>Result</th>
                                <th>Marks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(submission.mcqAnswers).forEach(([qNum, answer]) => {
                const question = paper.questions[qNum];
                if (!question || question.type !== 'mcq') return;

                const isCorrect = answer === question.answer;
                const marksEarned = isCorrect ? question.marks : 0;

                html += `
                    <tr class="${isCorrect ? 'table-success' : 'table-danger'}">
                        <td>${qNum}</td>
                        <td>${answer || 'Not answered'}</td>
                        <td>${question.answer}</td>
                        <td>${isCorrect ? 'Correct' : 'Incorrect'}</td>
                        <td>${marksEarned}/${question.marks}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-primary mt-3">
                    <strong>MCQ Score:</strong> ${submission.mcqScore || 0} / ${submission.totalMcqMarks || 0}
                </div>
            `;
        }

        // Show essay answers if available
        if (submission.essayAnswers && Object.keys(submission.essayAnswers).length > 0) {
            html += `
                <h5 class="mt-5 mb-3">Essay Answers</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Question</th>
                                <th>Your Answer</th>
                                <th>Marked Answer Sheet</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(submission.essayAnswers).forEach(([qNum, essay]) => {
                const markedAnswer = submission.markedEssayAnswers && submission.markedEssayAnswers[qNum];
                
                html += `
                    <tr>
                        <td>${qNum}</td>
                        <td>
                            <a href="${essay.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </td>
                        <td>
                            ${markedAnswer ? `
                                <a href="${markedAnswer.url}" target="_blank" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i> Download Marked
                                </a>
                            ` : `
                                <span class="text-muted">Not marked yet</span>
                            `}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }

        modalBody.innerHTML = html;
        new bootstrap.Modal(document.getElementById('studentAnswersModal')).show();

    } catch (error) {
        console.error('Error loading student answers:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${error.message}
            </div>
        `;
    }
}
    
//Link Sharing 
function handleUrlParams() {
    const hash = window.location.hash;
    if (!hash) return;

    const section = hash.substring(1).split('?')[0];
    
    // Allow direct access to papers and rankings sections without login
    if (section === 'papers' || section === 'ranks') {
        showSection(section);
        
        // Handle query params for rankings
        if (section === 'ranks') {
            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            const paperId = params.get('paper');
            const classFilter = params.get('class');
            
            if (paperId) {
                document.getElementById('rankPaperFilter').value = paperId;
                if (classFilter && document.getElementById('classFilter')) {
                    document.getElementById('classFilter').value = classFilter;
                }
                loadRankings(paperId);
            } else {
                showPaperSelectionDialog();
            }
        }
    } else if (checkAuth()) {
        showSection(section);
    }
}

function generatePaperRankingsLink(paperId) {
    return `${window.location.origin}${window.location.pathname}?section=paperClassRankings&paperId=${paperId}`;
}

// Add event listener
document.querySelectorAll('.share-rankings-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const paperId = this.getAttribute('data-id');
        const shareUrl = generatePaperRankingsLink(paperId);
        
        // Modern clipboard API
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback for older browsers
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = shareUrl;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showToast('Link copied to clipboard!', 'success');
        });
    });
});
    
function setupRankingsButtons() {
    // For "View Rankings" buttons in the papers list
    document.querySelectorAll('.view-paper-class-ranks-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const paperId = this.getAttribute('data-id');
            
            // Add loading state to button
            const originalHtml = this.innerHTML;
            this.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Loading...`;
            this.disabled = true;
            
            try {
                const success = await navigateToPaperRankings(paperId);
                if (!success) {
                    // Reset button if failed
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }
            } catch (error) {
                this.innerHTML = originalHtml;
                this.disabled = false;
                console.error('Error:', error);
            }
        });
    });

    // For "View Rankings" buttons in recent papers table
    document.querySelectorAll('.view-paper-rankings-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const paperId = this.getAttribute('data-paperid');
            
            // Add loading state to button
            const originalHtml = this.innerHTML;
            this.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Loading...`;
            this.disabled = true;
            
            try {
                const success = await navigateToPaperRankings(paperId);
                if (!success) {
                    // Reset button if failed
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }
            } catch (error) {
                this.innerHTML = originalHtml;
                this.disabled = false;
                console.error('Error:', error);
            }
        });
    });
}    
    
// Consolidated share function
function sharePaperRankingsLink(paperId) {
    try {
        const shareUrl = generatePaperRankingsLink(paperId);
        
        // Modern clipboard API
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(() => {
                fallbackCopyToClipboard(shareUrl);
            });
        } else {
            fallbackCopyToClipboard(shareUrl);
        }
    } catch (error) {
        console.error('Sharing failed:', error);
        showToast('Failed to copy link', 'danger');
    }
}

// Fallback for older browsers
function fallbackCopyToClipboard(text) {
    const tempInput = document.createElement('input');
    document.body.appendChild(tempInput);
    tempInput.value = text;
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showToast('Link copied to clipboard!', 'success');
}

    </script>
</body>
</html>
